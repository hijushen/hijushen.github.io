<!DOCTYPE HTML><html><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

<title>[共享平台]共享平台代码摘录.md</title>
    <!--mark |wiz_custom_css| for wizeditor replace it-->


<style id="wiz_custom_css">        html, body {            font-size: 15px;        }        body {            font-family: Helvetica, 'Hiragino Sans GB', '微软雅黑', 'Microsoft YaHei UI', SimSun, SimHei, arial, sans-serif;            line-height: 1.6;            margin: 0;            padding: 20px 36px;            padding: 1.33rem 2.4rem;        }        h1, h2, h3, h4, h5, h6 {            margin: 20px 0 10px;            margin: 1.33rem 0 0.667rem;            padding: 0;            font-weight: bold;        }        h1 {            font-size: 21px;            font-size: 1.4rem;        }        h2 {            font-size: 20px;            font-size: 1.33rem;        }        h3 {            font-size: 18px;            font-size: 1.2rem;        }        h4 {            font-size: 17px;            font-size: 1.13rem;        }        h5 {            font-size: 15px;            font-size: 1rem;        }        h6 {            font-size: 15px;            font-size: 1rem;            color: #777777;            margin: 1rem 0;        }        div, p, ul, ol, dl, li {            margin: 0;        }        blockquote, table, pre, code {            margin: 8px 0;        }        ul, ol {            padding-left: 32px;            padding-left: 2.13rem;        }        blockquote {            padding: 0 12px;            padding: 0 0.8rem;        }        blockquote > :first-child {            margin-top: 0;        }        blockquote > :last-child {            margin-bottom: 0;        }        img {            border: 0;            max-width: 100%;            height: auto !important;            margin: 2px 0;        }        table {            border-collapse: collapse;            border: 1px solid #bbbbbb;        }        td {            padding: 4px 8px;            border-collapse: collapse;            border: 1px solid #bbbbbb;        }        @media screen and (max-width: 660px) {            body {                padding: 20px 18px;                padding: 1.33rem 1.2rem;            }        }        @media only screen and (-webkit-max-device-width: 1024px), only screen and (-o-max-device-width: 1024px), only screen and (max-device-width: 1024px), only screen and (-webkit-min-device-pixel-ratio: 3), only screen and (-o-min-device-pixel-ratio: 3), only screen and (min-device-pixel-ratio: 3) {            html, body {                font-size: 17px;            }            body {                line-height: 1.7;                padding: 0.75rem 0.9375rem;                color: #353c47;            }            h1 {                font-size: 2.125rem;            }            h2 {                font-size: 1.875rem;            }            h3 {                font-size: 1.625rem;            }            h4 {                font-size: 1.375rem;            }            h5 {                font-size: 1.125rem;            }            h6 {                color: inherit;            }            ul, ol {                padding-left: 2.5rem;            }            blockquote {                padding: 0 0.9375rem;            }        }</style><style type="text/css" id="wiz_todo_style_id" wiz_link_version="01.00.09">.wiz-todo, .wiz-todo-img {width: 16px; height: 16px; cursor: default; padding: 0 10px 0 2px; vertical-align: -10%;-webkit-user-select: none;} .wiz-todo-label { display: inline-block; padding-top: 7px; padding-bottom: 6px; line-height: 1.5;} .wiz-todo-label-checked {  color: #666;} .wiz-todo-label-unchecked {text-decoration: initial;} .wiz-todo-completed-info {padding-left: 44px; display: inline-block; } .wiz-todo-avatar { width:20px; height: 20px; vertical-align: -20%; margin-right:10px; border-radius: 2px;} .wiz-todo-account, .wiz-todo-dt { color: #666; }</style></head>

<body  style=""><h2>平台代码摘录2-LINQ篇.md (2016-10-16 22:33:45)</h2><div>&gt; 北望江急帆快, 南瞻雾锁云流. 勾连楚尾与吴头. 世间无比景, 天下有名楼.</div><div>&gt; 商贾红颜绿酒, 骚人古恨今忧. 劝君到此莫逢秋. 秋光虽更好, 岁暮易生愁.</div><div>&nbsp;</div><div>- &nbsp;<label class="wiz-todo-label wiz-todo-label-checked"><img id="wiz_todo_1476628509847_908905" class="wiz-todo-img wiz-img-cannot-drag" src="[共享平台]共享平台代码摘录.md_files/checked.png" state="checked"><span class="wiz-todo-tail"></span></label><label class="wiz-todo-label wiz-todo-label-unchecked">完成gird 的三部分查看</label></div><div>- 目前来看使用grid的`&lt;group&gt; ` 插件形式: 完整代码: </div><div>```</div><div>&lt;Features&gt;</div><div>&nbsp;&nbsp;&nbsp; &lt;ext:Grouping ID="Grouping1" runat="server" HideGroupedHeader="true" GroupHeaderTplString='人员: {name} ({rows.length} 个岗位)'&gt;</div><div>&nbsp;&nbsp;&nbsp; &lt;/ext:Grouping&gt;</div><div> &lt;/Features&gt;</div><div>```</div><div>&nbsp;</div><div>- [ ] Bizs 的`Linq` 查询方式.</div><div>&nbsp;</div><div>### LINQ</div><div>#### Update</div><div>- AXXEntity.Update() 直接执行模式.</div><div>- AXXEntitys.Update(aXXEntity) 执行相应实体.</div><div>- AxxEntitys.Update(set =&gt; set.Value = value,&nbsp; c=&gt;c.whereValue==whereValue) ,第一个是设置相应字段, 第二个是设置where条件. 可以用在删除, 仅仅更新`DataStatus` 的等情况下使用.</div><div><br></div><hr /><div>[toc]</div><div>&nbsp;</div><div>## 逻辑方法 Bizs</div><div>### `BizListDataModel` 返回</div><div>&gt; 如果需要预处理, 复杂逻辑, 可以先实例化相应功能BizListDataModel result = new BizListDataModel{Data = .., Msg = ..} , 然后后续数据填充 </div><div>&nbsp;</div><div>- 用途：</div><div>&nbsp;&nbsp;&nbsp; - 返回列表数据</div><div>&nbsp;&nbsp;&nbsp; - 返回树形结构`BuilderTreeResult` ` &lt;struct&gt;` 类型作为`BizListDataModel` 的`Data` 返回</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - 实体`Entity List&lt;&gt; `返回</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - `DataTable` 循环 `DataRow` 构造树形结构.</div><div>&nbsp;&nbsp;&nbsp; - 实例(实体类型):</div><div>&nbsp;</div><div>```</div><div>///相应try也返回相应数据</div><div>var result = AXXModel.List();</div><div>return new BizDataModel</div><div>{</div><div>&nbsp;&nbsp;&nbsp; Data = result.JsonResult(),</div><div>&nbsp;&nbsp;&nbsp; total = result.Count,</div><div>&nbsp;&nbsp;&nbsp; Msg = ""</div><div>}</div><div>///DataTable获取属性结构</div><div>var dt = ...</div><div>var cc = this.BuilderTreeJson(dt,(DataRow row, JObject jobject) =&gt; {return new BuilderTreeResult{Left = row , ID=row[].., Text = row[]..}})</div><div>```</div><div>&nbsp;</div><div>### `BizDataModel` 返回</div><div>&gt; 如果需要预处理, 复杂逻辑, 可以先实例化相应功能BizDataModel result = new BizDataModel{Success = ..., Data = .., Msg = ..} , 然后后续数据填充.</div><div>&nbsp;</div><div>- 用途:</div><div>&nbsp;&nbsp;&nbsp; - 新增 / 更新</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - 单个</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - 序列化字符串, Update/Insert. 均可. 依赖的是主键</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - 批量</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - 序列化字符串成`List&lt;entity&gt;` 形式, 完成后一次插入或者使用事务, 循环实体列表, 单条插入.</div><div>&nbsp;&nbsp;&nbsp; - 删除</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - 更新`DataStatus = -1` 方式.&nbsp; 同 [新增/更新] . 获取时需要增加判断条件.</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - 删除.&nbsp; 得到主键或者实体反序列化列表后的到主键更新.</div><div>- 实例:</div><div>&nbsp;&nbsp;&nbsp; - 事务处理&nbsp;&nbsp; </div><div>```</div><div>&nbsp; using(TransactionScope transaction = new TransactionScope())</div><div>&nbsp; {</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach(Entity e&nbsp; in Entitys)</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; AXXEntity.Upate(e);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //AxxEntity.Delete(e);</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</div><div>&nbsp; }</div><div>&nbsp;</div><div>&nbsp; ```</div><div>- **DataTable** 数据的包装</div><div>- `DataTable`:**:**&nbsp;&nbsp;</div><div>```</div><div>**Step 1** : 使用`DataView dv = new DataView(); dv.Table = dt; dv.RowFilter = "ErrorType = 'RigidOver'"; var tmp2 = dv.ToTable(); var jsonStr = Newtonsoft.Json.JsonCovnert.SerialzeObject(dt); ` 一系列的`DataTable` 运作之后, **Step 2**: 使用 `var result = new BizDataModel{Success = true, Data = jsonStr; Msg = "done"}` 之类完成数据的返回.</div><div>```</div><div><br></div><div>### `string` 返回</div><div>- `JsonSerialize()`序列化返回</div><div>&nbsp;&nbsp;&nbsp; - `Newtonsoft.Json.Linq.JArray`</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; - 返回`DataTable` , 可以使用 `.Select("PID = {params}" ).OrderBy(s =&gt; s["column"].Tostring()).ToArray` 方式得到`DataRow[]` , 循环可以处理, 拼接`JObject -&gt; JArray` , 最后一次`.JsonSerialize()` 完成字符串生成.</div><div>&nbsp; &nbsp; &nbsp; &nbsp; - 包含树形结构的获取, 递归取下面的值构建相应的层级`JObject`对象, 参考示例: `GetBudgetValueList`<br></div><div>&nbsp;&nbsp;&nbsp; - 返回`HttpWebRequest`请求</div><div>### `void` 处理</div><div>&nbsp;</div><div>## Control片段</div><div>### MVC/Ext/控件 通用</div><div>#### `ActionResult` 类型:如返回`Index`方式</div><div>- 默认`return View()`对应相应`Views/Index.aspx`, 再比如: `BudgetValueChk()`对应`View/BudgetValueChk.aspx` 文件.</div><div>- 引申:`return View("../BasicData/BizSort")` 方式对应`Views/BasicData/BizSort.aspx` 文件, 需要注意的是, `controller`&nbsp; 通过网络访问时 仍然以路由注册为准,与所在文件夹没有关系 , 比如这里的`BizsortController` 虽然在`/Controller/BasicData` 目录下, 且`namespaces` 也是这个子目录, 但是通过网址访问不能加`/BasicData`, 同理, 注册路由到`Areas` 需要借鉴. `../` 想来这个上一级的作用, 半明了.</div><div>- `this.Store`, 使用`StoreResult`类型返回, 直接使用`Bizs`层`BiaListDataModel`的`Data` ,`total`作为返回值类型.</div><div>#### `JsonResult`类型.</div><div>- 增删改方法, 对`BizDataModel`类型, 都可以进一步根据数据组装需要返回的`json`类型, 返回给前台.</div><div>- 使用`JsonResult response = new JsonResult(){JsonRequestBehavior = JsonRequest.AllowGet};` 定义返回`Get`类型, 然后采用`response.Data = new {success=BizDataModel.Success, msg = BizDataModel.Msg}` 获得数据返回.</div><div>&nbsp;</div><div>&nbsp;</div><div>### 公司封装 </div><div>## 代码片段</div><div>### `Update`</div><div>&nbsp;</div><div>&nbsp;&nbsp;&nbsp; //entity AXXEntity 实例</div><div>&nbsp;&nbsp;&nbsp; AXXEntity.Update(set =&gt;</div><div>&nbsp;&nbsp;&nbsp; {</div><div>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; set.Orgid == entity.OrgiD;</div><div>&nbsp;&nbsp;&nbsp; }, c=&gt; c.BudgetIndex == entity.BugetInedx )</div><div>&nbsp;&nbsp;&nbsp; //代码功能: 前一个筛选出类型, 后一个where条件. 伪码出处: A12BudgetIndex.Update(...)</div><div>&nbsp;</div><div>### 已知可用/不可用 LINQ 组合</div><div>&nbsp;</div><div>&nbsp;&nbsp;&nbsp; //已知使用XXXEntity.Like().OrderBy()会报错.</div><div>&nbsp;&nbsp;&nbsp; BudgetBookList.Where(c =&gt; c.IsFirst == false &amp;&amp; c.DataStatus ==1).Sum(m =&gt; m.BudgetValue) 可以正常使用.</div><div>&nbsp;</div><div>&nbsp;</div></body></html>