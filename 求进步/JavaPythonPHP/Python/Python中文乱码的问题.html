<!DOCTYPE HTML><html><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

<title>Python中文乱码的问题</title>
    <!--mark |wiz_custom_css| for wizeditor replace it-->


<style id="wiz_custom_css">        html, body {            font-size: 15px;        }        body {            font-family: Helvetica, 'Hiragino Sans GB', '微软雅黑', 'Microsoft YaHei UI', SimSun, SimHei, arial, sans-serif;            line-height: 1.6;            margin: 0;            padding: 20px 36px;            padding: 1.33rem 2.4rem;        }        h1, h2, h3, h4, h5, h6 {            margin: 20px 0 10px;            margin: 1.33rem 0 0.667rem;            padding: 0;            font-weight: bold;        }        h1 {            font-size: 21px;            font-size: 1.4rem;        }        h2 {            font-size: 20px;            font-size: 1.33rem;        }        h3 {            font-size: 18px;            font-size: 1.2rem;        }        h4 {            font-size: 17px;            font-size: 1.13rem;        }        h5 {            font-size: 15px;            font-size: 1rem;        }        h6 {            font-size: 15px;            font-size: 1rem;            color: #777777;            margin: 1rem 0;        }        div, p, ul, ol, dl, li {            margin: 0;        }        blockquote, table, pre, code{            margin: 8px 0;        }        ul, ol {            padding-left: 32px;            padding-left: 2.13rem;        }        blockquote {            border-left: 4px solid #dddddd;            padding: 0 12px;            padding: 0 0.8rem;            color: #aaa;        }        blockquote > :first-child {            margin-top: 0;        }        blockquote > :last-child {            margin-bottom: 0;        }        img {            border: 0;            max-width: 100%;            height: auto !important;            margin: 2px 0;        }        table {            border-collapse: collapse;            border: 1px solid #bbbbbb;        }        td {            padding:4px 8px;            border-collapse: collapse;            border: 1px solid #bbbbbb;        }        @media screen and (max-width: 660px) {            body {                padding: 20px 18px;                padding: 1.33rem 1.2rem;            }        }        @media only screen and (-webkit-max-device-width: 1024px), only screen and (-o-max-device-width: 1024px), only screen and (max-device-width: 1024px), only screen and (-webkit-min-device-pixel-ratio: 3), only screen and (-o-min-device-pixel-ratio: 3), only screen and (min-device-pixel-ratio: 3) {            html, body {                font-size: 17px;            }            body {                line-height: 1.7;                padding: 0.75rem 0.9375rem;                color: #353c47;            }            h1 {                font-size: 2.125rem;            }            h2 {                font-size: 1.875rem;            }            h3 {                font-size: 1.625rem;            }            h4 {                font-size: 1.375rem;            }            h5 {                font-size: 1.125rem;            }            h6 {                color: inherit;            }            ul, ol {                padding-left: 2.5rem;            }            blockquote {                border-left: 4px solid #c8d4e8;                padding: 0 0.9375rem;                color: #b3c2dd;            }        }</style><style type="text/css" id="wiz_todo_style_id" wiz_link_version="01.00.09">.wiz-todo, .wiz-todo-img {width: 16px; height: 16px; cursor: default; padding: 0 10px 0 2px; vertical-align: -10%;-webkit-user-select: none;} .wiz-todo-label { display: inline-block; padding-top: 7px; padding-bottom: 6px; line-height: 1.5;} .wiz-todo-label-checked {  color: #666;} .wiz-todo-label-unchecked {text-decoration: initial;} .wiz-todo-completed-info {padding-left: 44px; display: inline-block; } .wiz-todo-avatar { width:20px; height: 20px; vertical-align: -20%; margin-right:10px; border-radius: 2px;} .wiz-todo-account, .wiz-todo-dt { color: #666; }</style></head>

<body  style=""><div class="art_desc mt10" style="margin: 10px 5px; padding: 10px; color: rgb(51, 51, 51); border-left-width: 3px; border-left-style: solid; border-left-color: rgb(59, 176, 219); font-size: 14px; font-family: tahoma, arial, 宋体; widows: 1; background-color: rgb(246, 251, 255); background-position: initial initial; background-repeat: initial initial;"><div id="art_demo" style="padding: 0px;">一直以来，python中的中文编码就是一个极为头大的问题，经常抛出编码转换的异常，python中的str和unicode到底是一个什么东西呢？</div></div><div class="lbd clearfix" id="bdctop" style="margin: 5px auto; padding: 0px; width: 680px; text-align: center; font-family: tahoma, arial, 宋体; font-size: 12px; line-height: 18px; widows: 1; background-color: rgb(255, 255, 255);"></div><div id="content" style="margin-right: 10px; margin-left: 10px; padding: 20px 5px 0px; width: 660px; line-height: 25.2px; clear: both; font-size: 14px; word-wrap: break-word; word-break: break-all; overflow: hidden; font-family: tahoma, arial, 宋体; widows: 1; background-color: rgb(255, 255, 255);"><p style="padding: 5px 0px;">在本文中，以'哈'来解释作示例解释所有的问题，“哈”的各种编码如下：&nbsp;<br>1. UNICODE (UTF8-16)，C854；&nbsp;<br>2． UTF-8，E59388；&nbsp;<br>3． GBK，B9FE。&nbsp;<br><strong>一、python中的str和unicode&nbsp;<br></strong>一直以来，python中的中文编码就是一个极为头大的问题，经常抛出编码转换的异常，python中的str和unicode到底是一个什么东西呢？&nbsp;<br>在python中提到unicode，一般指的是unicode对象，例如'哈哈'的unicode对象为&nbsp;<br>u'\u54c8\u54c8'&nbsp;<br>而str，是一个字节数组，这个字节数组表示的是对unicode对象编码(可以是utf-8、gbk、cp936、GB2312)后的存储的格式。这里它仅仅是一个字节流，没有其它的含义，如果你想使这个字节流显示的内容有意义，就必须用正确的编码格式，解码显示。&nbsp;<br>例如：<br><span style="line-height: 21.6px; font-size: 12px; font-family: 宋体;"><img height="225" alt="python 字符串和unicode" src="Python中文乱码的问题_files/30734133-77ac-4bda-bd20-d2d23d272c2b.png" width="341" style="border: 1px solid rgb(204, 204, 204); vertical-align: bottom; padding: 1px; overflow: hidden; max-width: 650px;"><br></span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;"><span style="line-height: 21.6px; font-family: 宋体;">对于unicode对象哈哈进行编码，编码成一个utf-8编码的str－s_utf8,s_utf8就是是一个字节数组，存放的就是'\xe5\x93\x88\xe5\x93\x88'，但是这仅仅是一个字节数组，如果你想将它通过print语句输出成哈哈，那你就失望了，为什么呢？</span></span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;"><span style="line-height: 21.6px; font-family: 宋体;">因为print语句它的实现是将要输出的内容传送了操作系统，操作系统会根据系统的编码对输入的字节流进行编码，这就解释了为什么utf-8格式的字符串“哈哈”，输出的是“鍝堝搱”，因为 '\xe5\x93\x88\xe5\x93\x88'用GB2312去解释，其显示的出来就是“鍝堝搱”。这里再强调一下，str记录的是字节数组，只是某种编码的存储格式，至于输出到文件或是打印出来是什么格式，完全取决于其解码的编码将它解码成什么样子。</span></span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;"><span style="line-height: 21.6px; font-family: 宋体;">这里再对print进行一点补充说明：当将一个unicode对象传给print时，在内部会将该unicode对象进行一次转换，转换成本地的默认编码（这仅是个人猜测）</span></span></p><h4 style="margin-top: 0px; margin-bottom: 0px; font-size: 14px; color: rgb(0, 102, 153);"><span style="line-height: 21.6px; font-size: 12px;">二、str<span style="line-height: 21.6px; font-family: 宋体;">和unicode对象的转换</span></span></h4><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;">str<span style="line-height: 21.6px; font-family: 宋体;">和unicode对象的转换，通过encode和decode实现，具体使用如下：</span></span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;"><span style="line-height: 21.6px; font-family: 宋体;"><img height="57" alt="decode和encode演示" src="Python中文乱码的问题_files/923b3a91-754e-4912-b6ac-c759daab2197.png" width="338" style="border: 1px solid rgb(204, 204, 204); vertical-align: bottom; padding: 1px; overflow: hidden; max-width: 650px;"></span></span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;"><span style="line-height: 21.6px; font-family: 宋体;">将GBK'哈哈'转换成unicode，然后再转换成UTF8</span></span></p><h4 style="margin-top: 0px; margin-bottom: 0px; font-size: 14px; color: rgb(0, 102, 153);"><span style="line-height: 21.6px; font-size: 12px;"><span style="line-height: 21.6px; font-family: 宋体;">三、Setdefaultencoding</span></span></h4><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;"><span style="line-height: 21.6px; font-family: 宋体;"><img height="240" alt="setdefaultencoding" src="Python中文乱码的问题_files/bfc54ab0-96b5-4e74-9e3c-11709a7efcc4.png" width="640" style="border: 1px solid rgb(204, 204, 204); vertical-align: bottom; padding: 1px; overflow: hidden; max-width: 650px;"></span></span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;"><span style="line-height: 21.6px; font-family: 宋体;">如上图的演示代码所示：<br></span></span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;"><span style="line-height: 21.6px; font-family: 宋体;">当把s(gbk字符串)直接编码成utf-8的时候，将抛出异常，但是通过调用如下代码：</span></span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;">import&nbsp;sys</span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;">reload(sys)</span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;">sys.setdefaultencoding('gbk')</span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;"><span style="line-height: 21.6px; font-family: 宋体;">后就可以转换成功，为什么呢？<span style="line-height: 21.6px; font-family: Verdana;"><span style="line-height: 21.6px;"><span style="line-height: 21.6px; font-family: 宋体;">在python中str和unicode在编码和解码过程中，如果将一个str直接编码成另一种编码，会先把str解码成unicode，采用的编码为默认编码，一般默认编码是</span></span><span style="line-height: 21.6px;">ansci</span><span style="line-height: 21.6px;">i<span style="line-height: 21.6px; font-family: 宋体;">，所以在上面示例代码中第一次转换的时候会出错，当设定当前默认编码为'gbk'后，就不会出错了。</span></span></span></span></span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;"><span style="line-height: 21.6px; font-family: 宋体;">至于reload(sys)是因为</span></span><span style="line-height: 21.6px; font-size: 12px;">Python2.5&nbsp;<span style="line-height: 21.6px; font-family: 宋体;">初始化后会删除&nbsp;sys.setdefaultencoding&nbsp;这个方法，我们需要重新载入</span></span><span style="line-height: 21.6px; font-size: 12px;"><span style="line-height: 21.6px; font-family: 宋体;">。</span></span></p><h4 style="margin-top: 0px; margin-bottom: 0px; font-size: 14px; color: rgb(0, 102, 153);"><span style="line-height: 21.6px; font-size: 12px;"><span style="line-height: 21.6px; font-family: 宋体;">四、操作不同文件的编码格式的文件</span></span></h4><p style="padding: 5px 0px;">建立一个文件test.txt，文件格式用ANSI，内容为:<br></p><p style="padding: 5px 0px;">abc中文</p><p style="padding: 5px 0px;">用python来读取</p><p style="padding: 5px 0px;"># coding=gbk</p><p style="padding: 5px 0px;">print open("Test.txt").read()</p><p style="padding: 5px 0px;">结果：abc中文</p><p style="padding: 5px 0px;">把文件格式改成UTF-8：</p><p style="padding: 5px 0px;">结果：abc涓枃</p><p style="padding: 5px 0px;">显然，这里需要解码：</p><p style="padding: 5px 0px;"># coding=gbk</p><p style="padding: 5px 0px;">import codecs</p><p style="padding: 5px 0px;">print open("Test.txt").read().decode("utf-8")</p><p style="padding: 5px 0px;">结果：abc中文</p><p style="padding: 5px 0px;">上面的test.txt我是用Editplus来编辑的，但当我用Windows自带的记事本编辑并存成UTF-8格式时，</p><p style="padding: 5px 0px;">运行时报错：</p><p style="padding: 5px 0px;">Traceback (most recent call last):</p><p style="padding: 5px 0px;">File "ChineseTest.py", line 3, in&nbsp;</p><p style="padding: 5px 0px;">print open("Test.txt").read().decode("utf-8")</p><p style="padding: 5px 0px;">UnicodeEncodeError: 'gbk' codec can't encode character u'\ufeff' in position 0: illegal multibyte sequence</p><p style="padding: 5px 0px;">原来，某些软件，如notepad，在保存一个以UTF-8编码的文件时，会在文件开始的地方插入三个不可见的字符（0xEF 0xBB 0xBF，即BOM）。</p><p style="padding: 5px 0px;">因此我们在读取时需要自己去掉这些字符，python中的codecs module定义了这个常量：</p><p style="padding: 5px 0px;"># coding=gbk</p><p style="padding: 5px 0px;">import codecs</p><p style="padding: 5px 0px;">data = open("Test.txt").read()</p><p style="padding: 5px 0px;">if data[:3] == codecs.BOM_UTF8:</p><p style="padding: 5px 0px;">data = data[3:]</p><p style="padding: 5px 0px;">print data.decode("utf-8")</p><p style="padding: 5px 0px;">结果：abc中文</p><p style="padding: 5px 0px;"><strong>五、文件的编码格式和编码声明的作用</strong></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;"><span style="line-height: 21.6px; font-family: 宋体;">源文件的编码格式对字符串的声明有什么作用呢？这个问题困扰一直困扰了我好久，现在终于有点眉目了，文件的编码格式决定了在该源文件中声明的字符串的编码格式，例如：</span></span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;">str&nbsp;=&nbsp;'<span style="line-height: 21.6px; font-family: 宋体;">哈哈'</span></span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;">print&nbsp;repr(str)</span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;">a.<span style="line-height: 21.6px; font-family: 宋体;">如果文件格式为utf-8，则str的值为：'\xe5\x93\x88\xe5\x93\x88'（哈哈的utf-8编码）</span></span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;">b.<span style="line-height: 21.6px; font-family: 宋体;">如果文件格式为gbk，则str的值为：'\xb9\xfe\xb9\xfe'（哈哈的gbk编码）</span></span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;"><span style="line-height: 21.6px; font-family: 宋体;">在第一节已经说过，python中的字符串，只是一个字节数组，所以当把a情况的str输出到gbk编码的控制台时，就将显示为乱码：鍝堝搱；而当把b情况下的str输出utf-8编码的控制台时，也将显示乱码的问题，是什么也没有，也许'\xb9\xfe\xb9\xfe'用utf-8解码显示，就是空白吧。&gt;_&lt;</span></span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;"><span style="line-height: 21.6px; font-family: 宋体;">说完文件格式，现在来谈谈编码</span></span><span style="line-height: 21.6px; font-size: 12px;"><span style="line-height: 21.6px; font-family: 宋体;">声明</span></span><span style="line-height: 21.6px; font-size: 12px;"><span style="line-height: 21.6px; font-family: 宋体;">的作用吧，每个文件在最上面的地方，都会用#&nbsp;coding=gbk&nbsp;类似的语句声明一下编码，但是这个声明到底有什么用呢？到止前为止，我觉得它的作用也就是三个：</span></span></p><p style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px; font-family: 宋体;"></span></p><ol style="padding: 0.3em 0px; list-style-position: initial; list-style-image: initial; line-height: 25px;"><li style="padding: 0px; list-style-type: decimal;">声明源文件中将出现非ascii编码，通常也就是中文；</li><li style="padding: 0px; list-style-type: decimal;">在高级的IDE中，IDE会将你的文件格式保存成你指定编码格式。</li><li style="padding: 0px; list-style-type: decimal;">决定源码中类似于u'哈'这类声明的将‘哈'解码成unicode所用的编码格式，也是一个比较容易让人迷惑的地方，看示例：</li></ol><p style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px; font-family: Verdana;">#coding:gbk</span><br></p><p style="padding: 5px 0px;"></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;">ss&nbsp;=&nbsp;u'<span style="line-height: 21.6px; font-family: 宋体;">哈哈'</span></span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;">print&nbsp;repr(ss)</span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;">print&nbsp;'ss:%s'&nbsp;%&nbsp;ss</span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;"><span style="line-height: 21.6px; font-family: 宋体;">将这个些代码保存成一个utf-8文本，运行，你认为会输出什么呢？大家第一感觉肯定输出的肯定是：</span></span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;">u'\u54c8\u54c8'</span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;">ss:<span style="line-height: 21.6px; font-family: 宋体;">哈哈</span></span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;"><span style="line-height: 21.6px; font-family: 宋体;">但是实际上输出是：</span></span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;">u'\u935d\u581d\u6431'</span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;">ss:<span style="line-height: 21.6px; font-family: 宋体;">鍝堝搱</span></span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;"><span style="line-height: 21.6px; font-family: 宋体;">为什么会这样，这时候，就是编码声明在作怪了，在运行ss&nbsp;=&nbsp;u'哈哈'的时候，整个过程可以分为以下几步：</span></span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;">1)&nbsp;</span><span style="line-height: 21.6px; font-size: 12px;"><span style="line-height: 21.6px; font-family: 宋体;">获取'哈哈'的编码：由文件编码格式确定，为'\xe5\x93\x88\xe5\x93\x88'（哈哈的utf-8编码形式）</span></span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;">2)&nbsp;</span><span style="line-height: 21.6px; font-size: 12px;"><span style="line-height: 21.6px; font-family: 宋体;">转成 unicode编码的时候，在这个转换的过程中，对于'\xe5\x93\x88\xe5\x93\x88'的解码，不是用utf-8解码，而是用声明编码处指定的编码GBK，将'\xe5\x93\x88\xe5\x93\x88'按GBK解码，得到就是''鍝堝搱''，这三个字的unicode编码就是u'\u935d\u581d\u6431'，至止可以解释为什么print&nbsp;repr(ss)输出的是u'\u935d\u581d\u6431' 了。</span></span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;"><span style="line-height: 21.6px; font-family: 宋体;">好了，这里有点绕，我们来分析下一个示例：</span></span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;">#-*-&nbsp;coding:utf-8&nbsp;-*-</span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;">ss&nbsp;=&nbsp;u'<span style="line-height: 21.6px; font-family: 宋体;">哈哈'</span></span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;">print&nbsp;repr(ss)</span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;">print&nbsp;'ss:%s'&nbsp;%&nbsp;ss</span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;"><span style="line-height: 21.6px; font-family: 宋体;">将这个示例这次保存成GBK编码形式，运行结果，竟然是：</span></span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;">UnicodeDecodeError:&nbsp;'utf8'&nbsp;codec&nbsp;can't&nbsp;decode&nbsp;byte&nbsp;0xb9&nbsp;in&nbsp;position&nbsp;0:&nbsp;unexpected&nbsp;code&nbsp;byte</span></p><p class="p0" style="padding: 5px 0px;"><span style="line-height: 21.6px; font-size: 12px;"><span style="line-height: 21.6px; font-family: 宋体;">这里为什么会有utf8解码错误呢？想想上个示例也明白了，转换第一步，因为文件编码是GBK，得到的是'哈哈'编码是GBK的编码'\xb9\xfe\xb9\xfe'，当进行第二步，转换成 unicode的时候，会用UTF8对'\xb9\xfe\xb9\xfe'进行解码，而大家查utf-8的编码表会发现，utf8编码表（关于UTF- 8解释可参见字符编码笔记：ASCII、UTF-8、UNICODE）中根本不存在，所以会报上述错误。</span></span></p><br><div style="color:gray"><small>来源：&nbsp;<a href="http://www.jb51.net/article/26543.htm">http://www.jb51.net/article/26543.htm</a></small></div><div></div></div></body></html>