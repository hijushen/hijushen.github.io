<meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>windows 服务与系统托盘之间的交互</title><?xml version="1.0" encoding="UTF-8"?>


<div style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;"><div style="margin: 5px 0px; font-size: 20px; line-height: 30px; font-family: &#39;Microsoft YaHei&#39;; text-align: left; background-color: rgb(255, 255, 255);">&nbsp;
<h3 style="margin: 0px; padding: 0px; display: inline; font-weight: normal; font-size: 20px; vertical-align: middle;"><a href="http://blog.csdn.net/yanpingsoft/article/details/7838848" style="color: rgb(0, 0, 0); text-decoration: none;">windows 服务与系统托盘之间的交互</a></h3></div><div style="padding: 5px 0px; color: rgb(153, 153, 153); font-size: 12px; line-height: 24px; font-family: Arial; text-align: right; background-color: rgb(255, 255, 255);"><span style="margin: 0px 5px 0px 0px;">2012-08-07 14:12</span>&nbsp;<span style="margin: 0px 5px; padding: 0px 0px 0px 14px; background-image: url(&quot;&quot;); background-position: 0% 50%; background-repeat: no-repeat no-repeat;" title="阅读次数">244人阅读</span>&nbsp;<span style="margin: 0px 5px; padding: 0px 0px 0px 14px; background-image: url(&quot;&quot;); background-position: 0% 50%; background-repeat: no-repeat no-repeat;" title="评论次数"><a href="http://blog.csdn.net/yanpingsoft/article/details/7838848#comments" style="color: rgb(51, 102, 153); text-decoration: none;">评论</a>(0)</span>&nbsp;<span style="margin: 0px 5px;"><a style="color: rgb(51, 102, 153);" title="收藏">收藏</a></span>&nbsp;<span style="margin: 0px 5px;"><a href="http://blog.csdn.net/yanpingsoft/article/details/7838848#report" style="color: rgb(51, 102, 153); text-decoration: none;" title="举报">举报</a></span></div><div style="margin: 10px 0px; color: rgb(51, 51, 51); font-family: Arial, Console, Verdana, &#39;Courier New&#39;; font-size: 12px; text-align: left; background-color: rgb(255, 255, 255);"><a href="http://www.csdn.net/tag/windows" style="color: rgb(51, 102, 153); text-decoration: none; display: inline-block; padding: 4px 10px; line-height: 12px; margin-right: 10px; border: 1px solid rgb(238, 238, 238); background-color: rgb(238, 238, 238); border-top-left-radius: 10px; border-top-right-radius: 10px; border-bottom-right-radius: 10px; border-bottom-left-radius: 10px;" target="_blank">windows</a><a href="http://www.csdn.net/tag/string" style="color: rgb(51, 102, 153); text-decoration: none; display: inline-block; padding: 4px 10px; line-height: 12px; margin-right: 10px; border: 1px solid rgb(238, 238, 238); background-color: rgb(238, 238, 238); border-top-left-radius: 10px; border-top-right-radius: 10px; border-bottom-right-radius: 10px; border-bottom-left-radius: 10px;" target="_blank">string</a><a href="http://www.csdn.net/tag/service" style="color: rgb(51, 102, 153); text-decoration: none; display: inline-block; padding: 4px 10px; line-height: 12px; margin-right: 10px; border: 1px solid rgb(238, 238, 238); background-color: rgb(238, 238, 238); border-top-left-radius: 10px; border-top-right-radius: 10px; border-bottom-right-radius: 10px; border-bottom-left-radius: 10px;" target="_blank">service</a><a href="http://www.csdn.net/tag/null" style="color: rgb(51, 102, 153); text-decoration: none; display: inline-block; padding: 4px 10px; line-height: 12px; margin-right: 10px; border: 1px solid rgb(238, 238, 238); background-color: rgb(238, 238, 238); border-top-left-radius: 10px; border-top-right-radius: 10px; border-bottom-right-radius: 10px; border-bottom-left-radius: 10px;" target="_blank">null</a><a href="http://www.csdn.net/tag/qq" style="color: rgb(51, 102, 153); text-decoration: none; display: inline-block; padding: 4px 10px; line-height: 12px; margin-right: 10px; border: 1px solid rgb(238, 238, 238); background-color: rgb(238, 238, 238); border-top-left-radius: 10px; border-top-right-radius: 10px; border-bottom-right-radius: 10px; border-bottom-left-radius: 10px;" target="_blank">qq</a></div><div style="margin: 20px 0px 0px; font-size: 14px; line-height: 26px; font-family: Arial; color: rgb(51, 51, 51); text-align: left; background-color: rgb(255, 255, 255);"><p>&nbsp; 有的时候我们需要自己写服务，而且需要给绑定一个 托盘！用来更加方便的 控制我们的程序！例如 QQ 那种！</p><p>下面我来讲一下他们之间是怎么关联的！</p><p>&nbsp;&nbsp; 有怎么几步！</p><p>&nbsp; 1，自己写一个服务，（上一篇博客中有详细的介绍，可以去参考！）</p><p>&nbsp;&nbsp;2，桌面交互的配置</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; 在serviceInstaller1_Committed事件中添加如下代码：</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;ConnectionOptions coOptions = new ConnectionOptions();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; coOptions.Impersonation = ImpersonationLevel.Impersonate;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ManagementScope mgmtScope = new System.Management.ManagementScope(@&quot;root\CIMV2&quot;, coOptions);</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mgmtScope.Connect();<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ManagementObject wmiService;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; wmiService = new ManagementObject(&quot;Win32_Service.Name=&#39;&quot; + serviceInstaller1.ServiceName + &quot;&#39;&quot;);</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ManagementBaseObject InParam = wmiService.GetMethodParameters(&quot;Change&quot;);</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; InParam[&quot;DesktopInteract&quot;] = true;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ManagementBaseObject OutParam = wmiService.InvokeMethod(&quot;Change&quot;, InParam, null);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 此段代码即是将此Service设置为“允许与桌面交互”，有了此选项之后，服务启动时GUI程序的界面将会出现。</p><p>&nbsp;&nbsp; 3，与托盘程序的关联，这是一个单独的方法！因为托盘程序 一般都是一个单独的程序！所以哦我们在服务只能去调用托盘程序！在服务启动的时候启动托盘程序！</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected void Formstart()<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string serviceControl = @&quot;E:\学习项目\windows服务控制\WinServicesControl\WinServicesControl\bin\Debug\WinServicesControl.exe&quot;;//&nbsp;托盘程序.exe的路径<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; bool ico = false;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Process[] processOnComputer=Process.GetProcesses();&nbsp;&nbsp; // 调出所有的进程，查找是否有我们需要的 托盘程序的进程！<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; foreach(Process p in processOnComputer)&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (p.ProcessName == &quot;WinServicesControl&quot;)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;遍历所有的进程<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ico = true;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // 如果有，就可以直接执行 托盘程序里的方法了！<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if&nbsp;&nbsp; (!ico)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //如果没有托盘程序的进程！我们就需要新建一个进程，去启动托盘程序！<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; string control = serviceControl;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Process p = new Process();&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ProcessStartInfo startInfo = new ProcessStartInfo(control);<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; p.StartInfo = startInfo;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; p.Start();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</p><p>&nbsp;&nbsp;&nbsp; 4，安装自己的写好的服务！（上一篇博客中有详细的介绍，可以去参考）</p><p>&nbsp;&nbsp;&nbsp;&nbsp;5，找到自己写的服务，属性，设置！如下图！</p><p>&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src="http://my.csdn.net/uploads/201208/07/1344319607_8481.jpg" style="cursor: default;"/></p><p>&nbsp;</p><p>这样在启动我们的服务的时候，我们写好的托盘程序就会执行了！也就是说能够看到我们的 托盘图标了！</p><p>&nbsp;</p><p>在下一篇文章中，我会介绍一个 那个单独的托盘程序！</p></div></div>