<!DOCTYPE HTML><html><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

<title>基础拾遗9 P/Invoke</title><!--?xml version="1.0" encoding="UTF-8"?-->


<style type="text/css" id="wiz_todo_style_id" wiz_link_version="01.00.09">.wiz-todo, .wiz-todo-img {width: 16px; height: 16px; cursor: default; padding: 0 10px 0 2px; vertical-align: -10%;-webkit-user-select: none;} .wiz-todo-label { display: inline-block; padding-top: 7px; padding-bottom: 6px; line-height: 1.5;} .wiz-todo-label-checked {  color: #666;} .wiz-todo-label-unchecked {text-decoration: initial;} .wiz-todo-completed-info {padding-left: 44px; display: inline-block; } .wiz-todo-avatar { width:20px; height: 20px; vertical-align: -20%; margin-right:10px; border-radius: 2px;} .wiz-todo-account, .wiz-todo-dt { color: #666; }</style><link type="text/css" rel="stylesheet" id="wiz_code_highlight_link" href="基础拾遗9 P-Invoke_files/wiz_code_highlight_23.css"></head><body  style=""><div style="word-wrap: break-word; -webkit-nbsp-mode: space; -webkit-line-break: after-white-space;">
1）P/Invoke：受控代码和非受控代码在交互时会产生一个事物（transition），这通常发生在使用平台调用服务（Platform Invocation Services），即P/Invoke。如调用系统的API或与COM对象打交道，通过System.Runtime.InteropServices命名空间；虽然使用Interrop非常方便，但据估计每次调用事物都要执行10到40条指令，算起来开销不小，所以我们要尽量少调用事物，如果非用不可，本着一次调用执行多个动作，而不是多次调用每次只执行少量动作的原则。
<div><br><div>2）String 与 StringBuilder的区别：</div><div>&nbsp; &nbsp; &nbsp;String是一个引用类型，但赋值时会产生一个新的对象，而StringBuilder不会，所以在大量字符串拼接或频繁对某一字符串操作时最好使用StringBuilder，而不是String。Case：（使用Environment.TickCount 来测试效率）</div><div><div><pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-cs"><span class="pln">using </span><span class="typ">System</span><span class="pun">;</span></code></li><li class="L1"><code class="language-cs"><span class="pln">using </span><span class="typ">System</span><span class="pun">.</span><span class="typ">Collections</span><span class="pun">.</span><span class="typ">Generic</span><span class="pun">;</span></code></li><li class="L2"><code class="language-cs"><span class="pln">using </span><span class="typ">System</span><span class="pun">.</span><span class="typ">Text</span><span class="pun">;</span></code></li><li class="L3"><code class="language-cs"></code></li><li class="L4"><code class="language-cs"><span class="pln">namespace </span><span class="typ">Example22</span></code></li><li class="L5"><code class="language-cs"><span class="pun">{</span></code></li><li class="L6"><code class="language-cs"><span class="kwd">class</span><span class="pln"> </span><span class="typ">Program</span></code></li><li class="L7"><code class="language-cs"><span class="pln">  </span><span class="pun">{</span></code></li><li class="L8"><code class="language-cs"><span class="pln">     </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="typ">Main</span><span class="pun">(</span><span class="kwd">string</span><span class="pun">[]</span><span class="pln"> args</span><span class="pun">)</span></code></li><li class="L9"><code class="language-cs"><span class="pln">       </span><span class="pun">{</span></code></li><li class="L0"><code class="language-cs"><span class="pln">          </span><span class="kwd">const</span><span class="pln"> </span><span class="typ">int</span><span class="pln"> cycle </span><span class="pun">=</span><span class="pln"> </span><span class="lit">100000</span><span class="pun">;</span></code></li><li class="L1"><code class="language-cs"></code></li><li class="L2"><code class="language-cs"><span class="pln">          </span><span class="kwd">long</span><span class="pln"> vTickCount </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Environment</span><span class="pun">.</span><span class="typ">TickCount</span><span class="pun">;</span></code></li><li class="L3"><code class="language-cs"><span class="pln">          </span><span class="typ">String</span><span class="pln"> str </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">null</span><span class="pun">;</span></code></li><li class="L4"><code class="language-cs"><span class="pln">          </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="typ">int</span><span class="pln"> i </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i </span><span class="pun">&lt;</span><span class="pln"> cycle</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span></code></li><li class="L5"><code class="language-cs"><span class="pln">               str </span><span class="pun">+=</span><span class="pln"> i</span><span class="pun">.</span><span class="typ">ToString</span><span class="pun">();</span></code></li><li class="L6"><code class="language-cs"><span class="pln">          </span><span class="typ">Console</span><span class="pun">.</span><span class="typ">WriteLine</span><span class="pun">(</span><span class="str">"String: {0} MSEL"</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Environment</span><span class="pun">.</span><span class="typ">TickCount</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> vTickCount</span><span class="pun">);</span></code></li><li class="L7"><code class="language-cs"></code></li><li class="L8"><code class="language-cs"><span class="pln">          vTickCount </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Environment</span><span class="pun">.</span><span class="typ">TickCount</span><span class="pun">;</span></code></li><li class="L9"><code class="language-cs"><span class="pln">          </span><span class="com">//看到这个变量名我就生气，奇怪为什么大家都使它呢？ ：）</span></code></li><li class="L0"><code class="language-cs"><span class="pln">          </span><span class="typ">StringBuilder</span><span class="pln"> sb </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">StringBuilder</span><span class="pun">();</span></code></li><li class="L1"><code class="language-cs"><span class="pln">          </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="typ">int</span><span class="pln"> i </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i </span><span class="pun">&lt;</span><span class="pln"> cycle</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span></code></li><li class="L2"><code class="language-cs"><span class="pln">               sb</span><span class="pun">.</span><span class="typ">Append</span><span class="pun">(</span><span class="pln">i</span><span class="pun">);</span></code></li><li class="L3"><code class="language-cs"><span class="pln">          </span><span class="typ">Console</span><span class="pun">.</span><span class="typ">WriteLine</span><span class="pun">(</span><span class="str">"StringBuilder: {0} MSEL"</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Environment</span><span class="pun">.</span><span class="typ">TickCount</span><span class="pln"> </span><span class="pun">-</span><span class="pln"> vTickCount</span><span class="pun">);</span></code></li><li class="L4"><code class="language-cs"></code></li><li class="L5"><code class="language-cs"><span class="pln">          </span><span class="typ">Console</span><span class="pun">.</span><span class="typ">ReadLine</span><span class="pun">();</span></code></li><li class="L6"><code class="language-cs"><span class="pln">     </span><span class="pun">}</span></code></li><li class="L7"><code class="language-cs"><span class="pun">}</span></code></li><li class="L8"><code class="language-cs"><span class="pun">}</span><span class="pln"> </span></code></li></ol></pre></div><div><br></div></div></div><div>3）implicit与explicit的用法：implicit为隐式转换，explicit为显式转换。例如B = (B)A为隐式转换，B = A则为显式转换。如果是损失信息，如精度，则使用显式转换，以便在编译期就能警告客户调用端。</div><div><div><pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-cs"><span class="pln">using </span><span class="typ">System</span><span class="pun">;</span></code></li><li class="L1"><code class="language-cs"><span class="pln">using </span><span class="typ">System</span><span class="pun">.</span><span class="typ">Collections</span><span class="pun">.</span><span class="typ">Generic</span><span class="pun">;</span></code></li><li class="L2"><code class="language-cs"><span class="pln">using </span><span class="typ">System</span><span class="pun">.</span><span class="typ">Text</span><span class="pun">;</span></code></li><li class="L3"><code class="language-cs"></code></li><li class="L4"><code class="language-cs"><span class="pln">namespace </span><span class="typ">Example23</span></code></li><li class="L5"><code class="language-cs"><span class="pun">{</span></code></li><li class="L6"><code class="language-cs"><span class="kwd">class</span><span class="pln"> </span><span class="typ">Program</span></code></li><li class="L7"><code class="language-cs"><span class="pun">{</span></code></li><li class="L8"><code class="language-cs"><span class="com">//本例灵感来源于大话西游经典台词“神仙？妖怪？”--主要是我实在想不出什么好例子了</span></code></li><li class="L9"><code class="language-cs"><span class="kwd">class</span><span class="pln"> </span><span class="typ">Immortal</span></code></li><li class="L0"><code class="language-cs"><span class="pun">{</span></code></li><li class="L1"><code class="language-cs"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">string</span><span class="pln"> name</span><span class="pun">;</span></code></li><li class="L2"><code class="language-cs"><span class="kwd">public</span><span class="pln"> </span><span class="typ">Immortal</span><span class="pun">(</span><span class="kwd">string</span><span class="pln"> </span><span class="typ">Name</span><span class="pun">)</span></code></li><li class="L3"><code class="language-cs"><span class="pln">  </span><span class="pun">{</span></code></li><li class="L4"><code class="language-cs"><span class="pln">     name </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Name</span><span class="pun">;</span></code></li><li class="L5"><code class="language-cs"><span class="pun">}</span></code></li><li class="L6"><code class="language-cs"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">implicit</span><span class="pln"> </span><span class="kwd">operator</span><span class="pln"> </span><span class="typ">Monster</span><span class="pun">(</span><span class="typ">Immortal</span><span class="pln"> value</span><span class="pun">)</span></code></li><li class="L7"><code class="language-cs"><span class="pln">  </span><span class="pun">{</span></code></li><li class="L8"><code class="language-cs"><span class="pln">     </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Monster</span><span class="pun">(</span><span class="pln">value</span><span class="pun">.</span><span class="pln">name </span><span class="pun">+</span><span class="pln"> </span><span class="str">"：神仙变妖怪？偷偷下凡即可。。。"</span><span class="pun">);</span></code></li><li class="L9"><code class="language-cs"><span class="pun">}</span></code></li><li class="L0"><code class="language-cs"><span class="pun">}</span></code></li><li class="L1"><code class="language-cs"><span class="kwd">class</span><span class="pln"> </span><span class="typ">Monster</span></code></li><li class="L2"><code class="language-cs"><span class="pun">{</span></code></li><li class="L3"><code class="language-cs"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">string</span><span class="pln"> name</span><span class="pun">;</span></code></li><li class="L4"><code class="language-cs"><span class="kwd">public</span><span class="pln"> </span><span class="typ">Monster</span><span class="pun">(</span><span class="kwd">string</span><span class="pln"> </span><span class="typ">Name</span><span class="pun">)</span></code></li><li class="L5"><code class="language-cs"><span class="pln">  </span><span class="pun">{</span></code></li><li class="L6"><code class="language-cs"><span class="pln">     name </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Name</span><span class="pun">;</span></code></li><li class="L7"><code class="language-cs"><span class="pun">}</span></code></li><li class="L8"><code class="language-cs"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> explicit </span><span class="kwd">operator</span><span class="pln"> </span><span class="typ">Immortal</span><span class="pun">(</span><span class="typ">Monster</span><span class="pln"> value</span><span class="pun">)</span></code></li><li class="L9"><code class="language-cs"><span class="pln">  </span><span class="pun">{</span></code></li><li class="L0"><code class="language-cs"><span class="pln">     </span><span class="kwd">return</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Immortal</span><span class="pun">(</span><span class="pln">value</span><span class="pun">.</span><span class="pln">name </span><span class="pun">+</span><span class="pln"> </span><span class="str">"：妖怪想当神仙？再去修炼五百年！"</span><span class="pun">);</span></code></li><li class="L1"><code class="language-cs"><span class="pun">}</span></code></li><li class="L2"><code class="language-cs"><span class="pun">}</span></code></li><li class="L3"><code class="language-cs"><span class="kwd">static</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="typ">Main</span><span class="pun">(</span><span class="kwd">string</span><span class="pun">[]</span><span class="pln"> args</span><span class="pun">)</span></code></li><li class="L4"><code class="language-cs"><span class="pun">{</span></code></li><li class="L5"><code class="language-cs"><span class="typ">Immortal</span><span class="pln"> tmpImmortal </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Immortal</span><span class="pun">(</span><span class="str">"紫霞仙子"</span><span class="pun">);</span></code></li><li class="L6"><code class="language-cs"><span class="com">//隐式转换</span></code></li><li class="L7"><code class="language-cs"><span class="typ">Monster</span><span class="pln"> tmpObj1 </span><span class="pun">=</span><span class="pln"> tmpImmortal</span><span class="pun">;</span></code></li><li class="L8"><code class="language-cs"><span class="typ">Console</span><span class="pun">.</span><span class="typ">WriteLine</span><span class="pun">(</span><span class="pln">tmpObj1</span><span class="pun">.</span><span class="pln">name</span><span class="pun">);</span></code></li><li class="L9"><code class="language-cs"></code></li><li class="L0"><code class="language-cs"><span class="typ">Monster</span><span class="pln"> tmpMonster </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Monster</span><span class="pun">(</span><span class="str">"孙悟空"</span><span class="pun">);</span></code></li><li class="L1"><code class="language-cs"><span class="com">//显式转换</span></code></li><li class="L2"><code class="language-cs"><span class="typ">Immortal</span><span class="pln"> tmpObj2 </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">Immortal</span><span class="pun">)</span><span class="pln">tmpMonster</span><span class="pun">;</span></code></li><li class="L3"><code class="language-cs"><span class="typ">Console</span><span class="pun">.</span><span class="typ">WriteLine</span><span class="pun">(</span><span class="pln">tmpObj2</span><span class="pun">.</span><span class="pln">name</span><span class="pun">);</span></code></li><li class="L4"><code class="language-cs"></code></li><li class="L5"><code class="language-cs"><span class="typ">Console</span><span class="pun">.</span><span class="typ">ReadLine</span><span class="pun">();</span></code></li><li class="L6"><code class="language-cs"><span class="pun">}</span></code></li><li class="L7"><code class="language-cs"><span class="pun">}</span></code></li><li class="L8"><code class="language-cs"><span class="pun">}</span></code></li><li class="L8"><code class="language-cs"><span class="pun"><div><pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-cs"></code></li><li class="L1"><code class="language-cs"><span class="pun">结果：</span></code></li><li class="L2"><code class="language-cs"><span class="pun">紫霞仙子：神仙变妖怪？偷偷下凡即可。。。</span></code></li><li class="L3"><code class="language-cs"><span class="pun">孙悟空：妖怪想当神仙？再去修炼五百年！</span><span class="pln"> </span></code></li></ol></pre></div><div><br></div></span></code></li></ol></pre></div><div><br></div><br></div><div>4）Params的用法：params在方法成员的参数列表中使用，为该方法提供参数可变的能力，它在只能出现一次并且不能在其后再有参数定义，之前可以：</div><div><div><pre class="prettyprint linenums prettyprinted"><ol class="linenums"><li class="L0"><code class="language-cs"><span class="pln">using </span><span class="typ">System</span><span class="pun">;</span></code></li><li class="L1"><code class="language-cs"><span class="pln">using </span><span class="typ">System</span><span class="pun">.</span><span class="typ">Collections</span><span class="pun">.</span><span class="typ">Generic</span><span class="pun">;</span></code></li><li class="L2"><code class="language-cs"><span class="pln">using </span><span class="typ">System</span><span class="pun">.</span><span class="typ">Text</span><span class="pun">;</span></code></li><li class="L3"><code class="language-cs"></code></li><li class="L4"><code class="language-cs"><span class="pln">namespace </span><span class="typ">ConsoleApplication1</span></code></li><li class="L5"><code class="language-cs"><span class="pun">{</span></code></li><li class="L6"><code class="language-cs"><span class="kwd">class</span><span class="pln"> </span><span class="typ">App</span></code></li><li class="L7"><code class="language-cs"><span class="pun">{</span></code></li><li class="L8"><code class="language-cs"><span class="com">//第一个参数必须是整型，但后面的参数个数是可变的。</span></code></li><li class="L9"><code class="language-cs"><span class="com">//而且由于定的是object数组，所有的数据类型都可以做为参数传入</span></code></li><li class="L0"><code class="language-cs"><span class="kwd">public</span><span class="pln"> </span><span class="kwd">static</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="typ">UseParams</span><span class="pun">(</span><span class="typ">int</span><span class="pln"> id</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">params</span><span class="pln"> </span><span class="kwd">object</span><span class="pun">[]</span><span class="pln"> </span><span class="typ">list</span><span class="pun">)</span></code></li><li class="L1"><code class="language-cs"><span class="pun">{</span></code></li><li class="L2"><code class="language-cs"><span class="typ">Console</span><span class="pun">.</span><span class="typ">WriteLine</span><span class="pun">(</span><span class="pln">id</span><span class="pun">);</span></code></li><li class="L3"><code class="language-cs"><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="typ">int</span><span class="pln"> i </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i </span><span class="pun">&lt;</span><span class="pln"> </span><span class="typ">list</span><span class="pun">.</span><span class="typ">Length</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span></code></li><li class="L4"><code class="language-cs"><span class="pln">  </span><span class="pun">{</span></code></li><li class="L5"><code class="language-cs"><span class="pln">     </span><span class="typ">Console</span><span class="pun">.</span><span class="typ">WriteLine</span><span class="pun">(</span><span class="typ">list</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]);</span></code></li><li class="L6"><code class="language-cs"><span class="pun">}</span></code></li><li class="L7"><code class="language-cs"><span class="pun">}</span></code></li><li class="L8"><code class="language-cs"></code></li><li class="L9"><code class="language-cs"><span class="kwd">static</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="typ">Main</span><span class="pun">()</span></code></li><li class="L0"><code class="language-cs"><span class="pun">{</span></code></li><li class="L1"><code class="language-cs"><span class="com">//可变参数部分传入了三个参数，都是字符串类型</span></code></li><li class="L2"><code class="language-cs"><span class="typ">UseParams</span><span class="pun">(</span><span class="lit">1</span><span class="pun">,</span><span class="pln"> </span><span class="str">"a"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"b"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"c"</span><span class="pun">);</span></code></li><li class="L3"><code class="language-cs"><span class="com">//可变参数部分传入了四个参数，分别为字符串、整数、浮点数和双精度浮点数数组</span></code></li><li class="L4"><code class="language-cs"><span class="pln">  </span><span class="typ">UseParams</span><span class="pun">(</span><span class="lit">2</span><span class="pun">,</span><span class="pln"> </span><span class="str">"d"</span><span class="pun">,</span><span class="pln"> </span><span class="lit">100</span><span class="pun">,</span><span class="pln"> </span><span class="lit">33.33</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="kwd">double</span><span class="pun">[]</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="lit">1.1</span><span class="pun">,</span><span class="pln"> </span><span class="lit">2.2</span><span class="pln"> </span><span class="pun">});</span></code></li><li class="L5"><code class="language-cs"></code></li><li class="L6"><code class="language-cs"><span class="typ">Console</span><span class="pun">.</span><span class="typ">ReadLine</span><span class="pun">();</span></code></li><li class="L7"><code class="language-cs"><span class="pun">}</span></code></li><li class="L8"><code class="language-cs"><span class="pun">}</span></code></li><li class="L9"><code class="language-cs"><span class="pun">}</span></code></li><li class="L0"><code class="language-cs"><span class="pun">结果：</span></code></li><li class="L1"><code class="language-cs"><span class="lit">1</span></code></li><li class="L2"><code class="language-cs"><span class="pln">a</span></code></li><li class="L3"><code class="language-cs"><span class="pln">b</span></code></li><li class="L4"><code class="language-cs"><span class="pln">c</span></code></li><li class="L5"><code class="language-cs"><span class="lit">2</span></code></li><li class="L6"><code class="language-cs"><span class="pln">d</span></code></li><li class="L7"><code class="language-cs"><span class="lit">100</span></code></li><li class="L8"><code class="language-cs"><span class="lit">33.33</span></code></li><li class="L9"><code class="language-cs"><span class="typ">System</span><span class="pun">.</span><span class="typ">Double</span><span class="pun">[]</span><span class="pln">  </span></code></li></ol></pre></div><div><br></div></div></div></body></html>