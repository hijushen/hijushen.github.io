<!DOCTYPE html>
<html>
    <head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="format-detection" content="telephone=no">


        
        




        <link rel="dns-prefetch" href="http://res.wx.qq.com/">
<link rel="dns-prefetch" href="http://mmbiz.qpic.cn/">



        <title>C#委托浅析与漫谈</title>
        
<link rel="stylesheet" type="text/css" href="C#委托浅析与漫谈_files/page_mp_article_improve2d1390.css">
<style>
     
    </style>
<!--[if lt IE 9]>
<link rel="stylesheet" type="text/css" href="http://res.wx.qq.com/mmbizwap/zh_CN/htmledition/style/page/appmsg/page_mp_article_improve_pc2c9cd6.css">
<![endif]-->


    </head>
    <body id="activity-detail" class="zh_CN mm_appmsg" ontouchstart="">
        
    
    
    <div id="js_cmt_mine" class="discuss_container editing access" style="display:none;">
        <div class="discuss_container_inner">
            <h2 class="rich_media_title">C#委托浅析与漫谈</h2>
            <span id="log"></span>
            <div class="frm_textarea_box_wrp">
                <span class="frm_textarea_box">
                    <textarea id="js_cmt_input" class="frm_textarea" placeholder="留言将由公众号筛选后显示，对所有人可见。"></textarea>
                    <div class="emotion_tool">
                        <span class="emotion_switch" style="display:none;"></span>
                        <span id="js_emotion_switch" class="pic_emotion_switch_wrp">
                            <img class="pic_default" src="C#委托浅析与漫谈_files/icon_emotion_switch.2x278965.png" alt="">
                            <img class="pic_active" src="C#委托浅析与漫谈_files/icon_emotion_switch_active.2x278965.png" alt="">
                        </span>
                        <div class="emotion_panel" id="js_emotion_panel">
                            <span class="emotion_panel_arrow_wrp" id="js_emotion_panel_arrow_wrp">
                                <i class="emotion_panel_arrow arrow_out"></i>
                                <i class="emotion_panel_arrow arrow_in"></i>
                            </span>
                            <div class="emotion_list_wrp" id="js_slide_wrapper">
                                
                                
                            </div>
                            <ul class="emotion_navs" id="js_navbar">
                                
                            </ul>
                        </div>
                    </div>
                </span>
            </div>
            <div class="discuss_btn_wrp"><a id="js_cmt_submit" class="btn btn_primary btn_discuss btn_disabled" href="">提交</a></div>
            <div class="discuss_list_wrp" style="display:none">
                <div class="rich_tips with_line title_tips discuss_title_line">
                    <span class="tips">我的留言</span>
                </div>
                <ul class="discuss_list" id="js_cmt_mylist"></ul>
            </div>
            <div class="rich_tips tips_global loading_tips" id="js_mycmt_loading">
                <img src="C#委托浅析与漫谈_files/icon_loading_white2805ea.gif" class="rich_icon icon_loading_white" alt="">
                <span class="tips">加载中</span>
            </div>
            <div class="wx_poptips" id="js_cmt_toast" style="display:none;">
                <img alt="" class="icon_toast" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGoAAABqCAYAAABUIcSXAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA3NpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuNS1jMDE0IDc5LjE1MTQ4MSwgMjAxMy8wMy8xMy0xMjowOToxNSAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDoyMTUxMzkxZS1jYWVhLTRmZTMtYTY2NS0xNTRkNDJiOGQyMWIiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MTA3QzM2RTg3N0UwMTFFNEIzQURGMTQzNzQzMDAxQTUiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MTA3QzM2RTc3N0UwMTFFNEIzQURGMTQzNzQzMDAxQTUiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENDIChNYWNpbnRvc2gpIj4gPHhtcE1NOkRlcml2ZWRGcm9tIHN0UmVmOmluc3RhbmNlSUQ9InhtcC5paWQ6NWMyOGVjZTMtNzllZS00ODlhLWIxZTYtYzNmM2RjNzg2YjI2IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjIxNTEzOTFlLWNhZWEtNGZlMy1hNjY1LTE1NGQ0MmI4ZDIxYiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pmvxj1gAAAVrSURBVHja7J15rF1TFMbXk74q1ZKHGlMkJVIhIgg1FH+YEpEQJCKmGBpThRoSs5jVVNrSQUvEEENIhGiiNf9BiERICCFIRbUiDa2qvudbOetF3Tzv7XWGffa55/uS7593977n3vO7e5+199p7v56BgQGh0tcmvAUERREUQVEERREUQVEERREUQVEERREUQVEERREUQVEERREUQVEERVAUQVEERVAUQbVYk+HdvZVG8b5F0xj4RvhouB+eCy8KrdzDJc1RtAX8ILxvx98V1GyCSkN98Cx4z/95/Wn4fj6j6tUEeN4wkFSnw1MJqj5NhBfAuwaUHREUg4lqNMmePVsHll/HFhVfe1t3FwpJI8DXCCquDrCWNN4B6Tb4M3Z98aTPmTvh0YHl18PXw29yZiKejoPvcUD6E74yFBJbVDk6Bb7K8aP/Hb4c/tRzEYIqprPhSxzlf4Uvhb/0Xoig8qnHAJ3lqPMzfDH8XZ4LEpRf2sVdA5/sqPO9Qfop70UJyn+/boaPddT5yrq7VUUvTIVJI7q74MMddXR8NB1eXcYvhBpZm0s2w72/o86HFoKvLau/pYaXzjLMdUJ6y0LwtWV9CIIaXtvA8+G9HHV03u5q+K+yH47U0NoRngPv7KjzHDwTLj0bS1BDazfJJlcnOOostC6ysnCT+q80G/sIvFVgeW09D8FPVT0uoP7VfvAD8NjA8pqmuAN+OcYAjso0RbIZ8DGB5TVNcRO8JMaHY9SXSdfa3eeANJimWBLrA7JFiZwIXye+NMUV8CcxP2SRFjXefok7NRjSGZJlWUPvw2/wtNiQirSoXWyMsR28wR7AzzYM0oXw+Y7yK+CLJGeaoqjyrJSdZJD6Ov4+z5y6NJc0Az7NUecHydIUy+v60KNyQHoM3nKI1y7YCFiq0i7uBvgER52vDdKqWn9djhY1Dn4G3n6Ecqm2rF74dvgoR53S0hQxW9RJAZAGW5bSn58QJA27dQ7uIEedjywEX5NKVxCqsY6y+qA+LxFI4+yZ6oH0trWkNan80jygtIUsc5SflgAsDXgehfdx1KkkTRE76tN+Xue2jnTU0Ru1oIbvpt30bBtKhOp5yaaRkts0lic8V1i6dPcIRx2d/l8Y8XtNNEg7OOo8bl1kmmOKnDsO88CaYzejau0hWZqiL7C83oCH4SeTHvwV2BqqsHRVztSEYOmWF80NeXZT6Hd4KflResE9vCnBOlCyGfDNAstHTVPUDWoQ1t3iW+9WNizvlhfd4aerXd+ThqiMfNR6+9LvOOro5OY5JX2H4+F7HZD+kGzlamMgldWiirQsjcwWFbjmqZJteekJLK9pisvgL6RhKvuciZiwzrWWGapfrPy30kBVcSBIrw0aD3PU0XB6cehntq7rTMf7/2iQlktDVdXJLXlg6VjmiYBn6rWSTRCH6hvJ0hQrpcGq8oidsmHpTP8t8DGO9/vcWt9qabiqPgup1yKyQwvC2tSefZ73SSpNkUJ4PlLorlHZ+446nc8f3fIyywlJhwrTuwVSjBa1ccvSxN0hjjoK5xVrYZMd9V6XbFfgBukixTwGLg8sDam3dZR/wZ6L/dJlin1en8LS+bgpFbz3Ygvzu1J1HKxYNqxGpCmaCEo12rrBorD6LRp8UbpcdR5VWhTW35KlKd6QFqjuM2XzwlpnMxTvSkuUwuG/Xlg6NtPjbT6WFimF/VG6LEvXgn8QGDjMbBukVECFwhpoS+CQatfX2Q1q6H7wENHdrfCr0lKleEB9JyxNneus+VJpsVL9TwI6W65LovWIGl3KtVJaLv7LBwYTFEERFEVQFEERFEVQFEERFEVQFEERFEVQFEERFEVQFEERFFWq/hFgADUMN4RzT6/OAAAAAElFTkSuQmCC">
                <p class="toast_content">已留言</p>
            </div>
        </div>
    </div>

    <div id="js_article" class="rich_media">
        
        <div id="js_top_ad_area" class="top_banner">
 
        </div>
                

        <div class="rich_media_inner">
            <div id="page-content">
                <div id="img-content" class="rich_media_area_primary">
                    <h2 class="rich_media_title" id="activity-name">
                        C#委托浅析与漫谈 
                    </h2>
                    <div class="rich_media_meta_list">
                        						                        <em id="post-date" class="rich_media_meta rich_media_meta_text">2016-04-18</em>

                                                <a class="rich_media_meta rich_media_meta_link rich_media_meta_nickname" href="" id="post-user">DotNet</a>
                        <span class="rich_media_meta rich_media_meta_text rich_media_meta_nickname">DotNet</span>

                        <div id="js_profile_qrcode" class="profile_container" style="display:none;">
                            <div class="profile_inner">
                                <strong class="profile_nickname">DotNet</strong>
                                <img class="profile_avatar" id="js_profile_qrcode_img" src="" alt="">

                                <p class="profile_meta">
                                <label class="profile_meta_label">微信号</label>
                                <span class="profile_meta_value">iDotNet</span>
                                </p>

                                <p class="profile_meta">
                                <label class="profile_meta_label">功能介绍</label>
                                <span class="profile_meta_value">专注分享&nbsp;.NET&nbsp;相关技术文章、教程和工具。有时也会涉及到IT职场相关的一些东西，或者来点幽默趣文。</span>
                                </p>
                                
                            </div>
                            <span class="profile_arrow_wrp" id="js_profile_arrow_wrp">
                                <i class="profile_arrow arrow_out"></i>
                                <i class="profile_arrow arrow_in"></i>
                            </span>
                        </div>
                    </div>
                    
                    
                    
                    
                                                            
                                                            
                    
                    <div class="rich_media_content " id="js_content">
                        
                        <p style="line-height: 25.6px; max-width: 100%; min-height: 1em; white-space: pre-wrap; color: rgb(62, 62, 62); text-align: center; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; font-size: 14px; line-height: 25.6px; color: rgb(255, 0, 0); box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-family: Verdana; box-sizing: border-box !important; word-wrap: break-word !important;">（点击</span></strong></span><span style="max-width: 100%; font-size: 14px; line-height: 25.6px; color: rgb(0, 112, 192); box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-family: Verdana; box-sizing: border-box !important; word-wrap: break-word !important;">上方蓝字</span></strong></span><span style="max-width: 100%; font-size: 14px; line-height: 25.6px; color: rgb(255, 0, 0); box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-family: Verdana; box-sizing: border-box !important; word-wrap: break-word !important;">，可快速关注我们）</span></strong></span><span style="max-width: 100%; color: rgb(61, 167, 66); box-sizing: border-box !important; word-wrap: break-word !important;"></span></p><p style="line-height: 25.6px; white-space: normal; max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); text-align: center; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; color: rgb(255, 0, 0); font-size: 12px; box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-family: Verdana; box-sizing: border-box !important; word-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"  /></span></strong></span></p><blockquote style="line-height: 25.6px; white-space: normal; max-width: 100%; color: rgb(62, 62, 62); box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><p style="max-width: 100%; min-height: 1em; white-space: pre-wrap; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(0, 209, 0); font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">来源：伯乐在线 - taney&nbsp;</span></p><p style="max-width: 100%; min-height: 1em; white-space: pre-wrap; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 14px; color: rgb(0, 209, 0); box-sizing: border-box !important; word-wrap: break-word !important;">链接：http://blog.jobbole.com/99738/</span></p></blockquote><p style=""><br  /></p><h1 style="">1. 概述</h1><p style=""><br  /></p><p style="">委托是C#区别于其他语言的一个特色，用它我们能写出简洁优雅的代码、能很方便的实现对象间的交互。</p><p style=""><br  /></p><p style="">初学者可能会觉得委托体系很复杂：lambda表达式、语句lambda、匿名方法、委托、事件，光名词就一堆。其实<strong style="border: 0px;">这些只是C#编译器为我们提供的语法糖</strong>，在编译后它们都是MulticastDelegate类型的对象。而且从用途上讲主要也就两方面：<strong style="border: 0px;">将“方法对象化”和实现“观察者模式”</strong>，本文围绕这两方面，分享本人对委托中相关概念的理解，顺便介绍一些相关的其它东西。</p><p style=""><br  /></p><h1 style="">2. 闭包</h1><p style=""><br  /></p><p style="">闭包似乎在javascript里谈得比较多，其实只要支持定义”局部函数”的语言都会涉及到”闭包”的概念，像C++11的lambda、java的匿名内部类、Smalltalk的Block等。</p><p style=""><br  />在C#中也有闭包，比如下面这个简单的例子：</p><p style=""><br  /><strong style="border: 0px;">例1</strong></p><p style=""><strong style="border: 0px;"><br  /></strong></p><blockquote><p><span style="font-size: 12px; color: rgb(136, 136, 136);">int[] scores = { 100, 80, 60, 40, 20 };</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">var min = 60;</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">var passed = scores.Where((int i) =&gt; { return i &gt;= min; });</span></p></blockquote><p style=""><br  /></p><p style="">这里向Count这个扩展方法传入了一个匿名方法，注意这里变量min对于这个匿名方法很特殊，它对匿名方法来说叫”自由变量（free variable）”（与之相对的叫”bound variable”），因为它不是该匿名方法的参数，也不是它的局部变量，这段代码能成功编译是因为从<strong style="border: 0px;">词法作用域</strong>的角度看，min这个变量对于匿名方法内部是可见的。</p><p style=""><br  /></p><h2 style="">2.1 词法作用域（lexical scoping）</h2><p style=""><br  /></p><p style="">首先我们搞清一些概念：</p><p style=""><br  /></p><ul style="" class=" list-paddingleft-2"><li><p>scope：英语中有“视野”之义，表示<strong style="border: 0px;">符号名的可见范围</strong>。</p><p><br  /></p></li><li><p>extent：或叫lifetime，表示<strong style="border: 0px;">变量的一生</strong>。scope有时会影响extent。</p><p><br  /></p></li></ul><p style=""><strong style="border: 0px;">JavaScript中的变量提升</strong></p><p style=""><strong><br  /></strong>关于这两者区别的一个例子就是javascript中的“变量提升”：</p><p style=""><br  /><strong style="border: 0px;">例2</strong></p><p style=""><strong style="border: 0px;"><br  /></strong></p><p style=""><strong style="border: 0px;"></strong></p><blockquote><p><span style="font-size: 12px; color: rgb(136, 136, 136);">text = &#39;global variable&#39;;</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">function test(){</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; alert(text);</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">//猜猜这里会弹出什么？</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; var text = &quot;local variable&quot;;</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">};</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">test();</span></p></blockquote><p style=""><br  /></p><p style="">答案是弹出”undefined”。为什么？因为首先javascript是函数作用域，第二javascript中的<strong style="border: 0px;">局部变量名的scope贯穿整个函数</strong>，即函数中变量名在函数起始到结束范围内都是有效的，所以调用alert时text这个变量名被解析为局部变量，而这时还未执行到赋值语句，也就是局部text的extent还未开始，text只是个有效的变量名，并没有指向一个有效的对象，因此会弹出”undefined”。<br  />好，我们继续</p><p style=""><br  /></p><blockquote style=""><p style="border: 0px;">什么是<strong style="border: 0px;">词法作用域</strong>？</p></blockquote><p style=""><br  /></p><p style="">“词法作用域”也叫<strong style="border: 0px;">静态作用域(static scoping)</strong>，”词法”表示源代码级别，”静态”指发生在解释时/编译时（与之相对是运行时），根据字面可理解为“变量在源代码中的可见范围”。</p><p style=""><br  />因为是基于源代码的，所以看上去很符合我们的直观感受，大多数的编程语言，包括许多动态语言，都使用词法作用域的规则来进行标识符解析的。C#也不例外。<br  />我们通常所称的“闭包”全称叫“词法闭包”，它是指<strong style="border: 0px;">存储了一个函数和创建该函数时所处词法环境的对象</strong>。在闭包中，它访问的外部变量叫做“<strong style="border: 0px;">被捕捉的变量（captured variable）</strong>”。比如上面<strong style="border: 0px;">例1</strong>中，第3行，匿名方法内部使用了min这个符号，但min既不是匿名方法的参数，也不是它的局部变量，所以编译器开始从定义这个匿名方法的词法环境开始向上不断搜索min这个符号，成功找到后，将它“捕捉”进匿名方法里，形成“闭包”，传递给Count方法的其实是这个“闭包”。</p><p style=""><br  />“捕捉”到底是什么意思？把它复制一份？还是保存它的引用？带着疑问猜猜下面C#代码的执行结果：</p><p style=""><br  /><strong style="border: 0px;">例3</strong></p><p style=""><strong style="border: 0px;"><br  /></strong></p><blockquote><p><span style="font-size: 12px; color: rgb(136, 136, 136);">class Program</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">{</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; static void Main()</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; {</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; foreach(var i in MakeClosures(3))</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; {</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i();</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">//每次执行的结果是什么</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; Console.ReadKey();</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; }</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; static IEnumerableMakeClosures(int count)</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; {</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; var closures = new List();</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; for (var i = 0; i Add(() =&gt; Console.WriteLine(++i));</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; return closures;</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; }</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">}</span></p></blockquote><p><br  /></p><p style="">我们来分析一下。首先，C#中的捕捉是“<strong style="border: 0px;">按引用捕捉</strong>”，所以：</p><p style=""><br  /></p><ul style="" class=" list-paddingleft-2"><li><p>在循环中创建闭包时捕捉的并<strong style="border: 0px;">不是i那个时刻的值，而是i的引用，是i这个对象本身</strong>，所以这些闭包共享同一个i</p><p><br  /></p></li><li><p>i在循环中不断更新，当第一个闭包被调用时i == count</p><p><br  /></p></li></ul><p style="">所以这段代码的运行结果是”4,5,6″。</p><p style=""><br  />为什么循环结束了i还能被访问？因为它被捕捉到了闭包里，它的extent被延长到至少和闭包对象一样长。</p><p style=""><br  />大多数语言的闭包都是按引用捕捉（更符合直观感受），java比较非主流，它是按值捕捉（即复制，注意引用类型是复制引用）。所以请看下面的java代码：</p><p style=""><br  /></p><blockquote><p><span style="font-size: 12px;">public class Main{</span></p><p><span style="font-size: 12px;">&nbsp; &nbsp; public static void main(String[] args){</span></p><p><span style="font-size: 12px;">&nbsp; &nbsp; &nbsp; &nbsp; int i = 1;</span></p><p><span style="font-size: 12px;">&nbsp; &nbsp; &nbsp; &nbsp; Runnable runnable = new Runnable(){</span></p><p><span style="font-size: 12px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; @Override</span></p><p><span style="font-size: 12px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; public void run(){</span></p><p><span style="font-size: 12px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i = 2;</span></p><p><span style="font-size: 12px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p><span style="font-size: 12px;">&nbsp; &nbsp; &nbsp; &nbsp; };</span></p><p><span style="font-size: 12px;">&nbsp; &nbsp; &nbsp; &nbsp; runnable.run();</span></p><p><span style="font-size: 12px;">&nbsp; &nbsp; }</span></p><p><span style="font-size: 12px;">}</span></p></blockquote><p style=""><br  /></p><p style="">编译这段代码会报错：local variables referenced from an inner class must be final or effectively final，意思说”被内部类引用的局部变量必须由final修饰或实际上就是final的（就是自始至终都没有被重新赋值）”。</p><p style=""><br  />为什会这样呢？因为从直觉上看，这段代码执行runnable.run()后i应该变成2，但java是按值捕捉，i并不会变，为避免误解，所以Java语言规定被内部类访问的外部变量要是不可变。</p><p style=""><br  />要突破这一限制，我们可以“手动实现按引用捕捉”，即创建一个类，把需要修改的变量放到那个类里。</p><p style=""><br  />C++的lambda很灵活，它允许我们指定捕捉哪些变量、按值还是按引用捕捉。在构建闭包时，编译器生成一个重载了”()”操作符的类，把被捕捉的变量定义为它的成员。</p><p style=""><br  /></p><blockquote style=""><p style="border: 0px;">C#编译器是如何实现闭包的？</p></blockquote><p style=""><br  /></p><p style="">CLR的类型系统中并没有“匿名方法”、“闭包”这些概念，其实C#编译器为我们生成了一些代码，比如生成一个类，把被捕捉的变量和匿名方法打包进去，变成实例变量和实例方法。但具体怎么实现并没有具体的标准，只要能符合语言规范就行，所以这个不必深究，有兴趣的自己可以用反编译工具查看一下。</p><p style=""><br  /></p><h1 style="">3. 多播委托、事件与观察者模式</h1><p><br  /></p><p style=""><strong style="border: 0px;">观察者模式</strong>也叫”发布者/订阅者模式”是GoF设计模式中比较常用的一个，它是用来解决“一个对象需要在特定时刻通知n个其它对象”的问题的。</p><p style=""><br  /></p><p style="">比如：mvc中model在自己属性发生改变时发布广播，事先关注了的view会收到并更新自已的状态，使界面与程序内部状态保持同步，同时又保持了内部逻辑与界面的良好分离。</p><p style=""><br  />这里我演示一个简单的例子：</p><p style=""><br  />实现一个下载程序，下载时能显示进度。为实现逻辑与界面的分离，我们设计两个类：</p><p style=""><br  /></p><ul style="" class=" list-paddingleft-2"><li><p><code style="">Downloader</code>：下载器，用于执行下载任务</p><p><br  /></p></li><li><p>ProgressView：进度界面，显示进度条和百分比</p><p><br  /></p></li></ul><p style="">那么问题来了，下载器如何通知界面更新？直接告诉它（调用它的一个方法）？如果这样么做的话下载器和界面的耦合度就会过高，这里我们可以运用“依赖倒置”的思想，加入一个IProgressMonitor接口。于是初步设计是这样的：</p><p style=""><br  /><img  style="border: 0px; margin: auto; font-size: 0px; color: transparent; vertical-align: middle; display: block; clear: both;" class="" data-type="png" data-ratio="0.420863309352518" data-w=""   SRC="C#委托浅析与漫谈_files/0.png" /></p><p style=""><br  /></p><p style="">代码：</p><ul style="" class=" list-paddingleft-2"><br  /><li><p>IProgressMonitor.cs</p><p><br  /></p></li></ul><blockquote><p><span style="font-size: 12px;">//进度监视接口</span></p><p><span style="font-size: 12px;">interface IProgressMonitor</span></p><p><span style="font-size: 12px;">{</span></p><p><span style="font-size: 12px;">&nbsp; &nbsp; void OnProgress(int done, int total);</span></p><p><span style="font-size: 12px;">}</span></p></blockquote><p><br  /></p><ul style="" class=" list-paddingleft-2"><li><p><span style="">ProgressVeiw.cs</span></p><p><br  /></p></li></ul><blockquote><p><span style="font-size: 12px; color: rgb(136, 136, 136);">class ProgressVeiw : IProgressMonitor</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">{</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; const int LENGTH = 50;</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; string _last = String.Empty;</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; public void OnProgress(int done, int total)</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; {</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; var builder = new StringBuilder();</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; builder.Append(&#39;[&#39;);</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; var filled = (int)(done / (total + 0.0) * LENGTH);</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; for (var i = 0; i Append(i &#39; : &#39;_&#39;);</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; builder.Append(&#39;]&#39;);</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; if (done != total)</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; builder.AppendFormat(&quot; &nbsp; {0:p0}&quot;, done / (total + 0.0));</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; else</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; builder.Append(&quot; &nbsp; 完成！&quot;);</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp;</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">//回退之前打印的字符</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; for (var i = 0; i Length; ++i)</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Console.Write(&#39;b&#39;);</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp;</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; var state = builder.ToString();</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; _last = state;</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; Console.Write(state);</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; }</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">}</span></p></blockquote><p><br  /><span style=""></span></p><ul style="" class=" list-paddingleft-2"><li><p><span style="">Downloader.cs</span></p><p><span style=""></span></p></li></ul><ul style="" class=" list-paddingleft-2"><br  /></ul><blockquote><p><span style="font-size: 12px; color: rgb(136, 136, 136);">class Downloader</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">{</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; public void Download(string resource)</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; {</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; for (int i = 1, size = 10; i this.OnProrgess(i, size);</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Thread.Sleep(500);</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; }</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; public void AddMonitor(IProgressMonitor monitor)</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; {</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; this._monitors.Add(monitor);</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; }</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; public void RemoveMonitor(IProgressMonitor monitor)</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; {</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; this._monitors.Remove(monitor);</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; }</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; private void OnProrgess(int done, int total)</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; {</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; foreach (var i in this._monitors)</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; {</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; i.OnProgress(done, total);</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; }</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; private ICollection _monitors = new List();</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">//进度监视者集合</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">}</span></p></blockquote><p><span style=""></span><br  /></p><p><span style=""></span></p><ul style="" class=" list-paddingleft-2"><li><p><span style="">Program.cs</span></p></li></ul><p><br  /></p><blockquote><p><span style="font-size: 12px; color: rgb(136, 136, 136);">class Program</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">{</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; static void Main(string[] args)</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; {</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; var resouce = &quot;visual studio.iso&quot;;</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; var downloader = new Downloader();</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; downloader.AddMonitor(new ProgressVeiw());</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; Console.WriteLine(&quot;正在下载 &quot; + resouce);</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; downloader.Download(resouce);</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp;</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; Console.ReadKey();</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; }</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">}</span></p></blockquote><p style=""><br  /></p><p style="">整个逻辑是这样的：</p><p style=""><br  /></p><ul style="" class=" list-paddingleft-2"><li><p>创建下载器</p><p><br  /></p></li><li><p>ProgressView对下载进度“<strong style="border: 0px;">感兴趣</strong>”，就到下载器那“<strong style="border: 0px;">登记一下</strong>”</p><p><br  /></p></li><li><p>下载器开始下载</p><p><br  /></p></li><li><p>下载器下载过程进度有变化时就通知已登记了的对象，具体这些对象要干嘛，它不管，它只负责通知</p><p><br  /></p></li><li><p>ProgressView收到通知，更新界面</p><p><br  /></p></li></ul><p style="">从代码中可以看到，实现“登记”、“通知”是通过手动操作一个集合实现的，其实这种功能.Net已经帮我们实现，那就是多播委托。</p><p style=""><br  /></p><h2 style="">3.1 多播委托（MulticastDelegate）</h2><p><br  /></p><p style=""><strong style="border: 0px;"></strong><strong style="">委托类层次图</strong></p><p style=""><strong><br style=""  /></strong><img  style="" class="" data-type="jpeg" data-ratio="0.4910071942446043" data-w=""   SRC="C#委托浅析与漫谈_files/0_2.jpg" /></p><p style=""><span style="color: rgba(0, 0, 0, 0); font-size: 0px;"><br  /></span><span style="color: rgb(46, 46, 46); font-size: 15px;">.Net中所有具体委托类型其实都继承自MulticastDelegate，多播委托内部有一个数组，用来保存其它委托，这就是所谓的“委托链”，有了它就可以对多个委托进行组合，让一个委托可以一次执行多个操作。比如：</span></p><p style=""><span style="color: rgb(46, 46, 46); font-size: 15px;"><br  /></span></p><p style=""><span style="color: rgb(46, 46, 46); font-size: 15px;"></span></p><blockquote><p><span style="font-size: 12px; color: rgb(136, 136, 136);">Action act = ()=&gt;Console.WriteLine(&quot;动作1&quot;);</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">act += ()=&gt;Console.WriteLine(&quot;动作2&quot;);</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">act += ()=&gt;Console.WriteLine(&quot;动作3&quot;);</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">act();</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">//将打印出三行文字</span></p></blockquote><p style=""><br  /></p><p style="">这里编译器其实把<code style="">+=</code>操作符替换成了Delegate.Combine(Delegate a, Delegate b)方法，该方法内部又是直接调用第一个参数的CombineImpl方法。</p><p style=""><br  /></p><p style=""><strong style="border: 0px;">因此多播委托的作用在于，现实观察者模式就不用手动维护一个订阅者集合了。</strong>于是上面的例子可以重构成这样：</p><p style=""><br  /></p><ul style="" class=" list-paddingleft-2"><li><p>Downloader.cs</p><p><br  /></p></li></ul><blockquote><p><span style="font-size: 12px; color: rgb(136, 136, 136);">class Downloader</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">{</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; public void Download(string resource)</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; {</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; for (int i = 1, size = 10; i this.OnProrgess(i, size);</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; Thread.Sleep(500);</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; }</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; }</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp;</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp;&nbsp;</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">//因为有多播委托，所以这里不需要“登记”、“注销”方法了</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp;</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; private void OnProrgess(int done, int total)</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; {</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; if (this.DownloadProgress != null)</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; this.DownloadProgress(done, total);</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; }</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp;&nbsp;</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">//NOTE: 这里为了用 +=,-=操作符替代“登记”、“注销”方法，不得以将订阅者集合暴露出去</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; public Actionint, int&gt; DownloadProgress;</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">//进度回调链</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">}</span></p></blockquote><p><br  /></p><ul style="" class=" list-paddingleft-2"><li><p>删除IProgressMonitor接口，因为只需要委托签名匹配即可，不需要用接口来约束</p><p><br  /></p></li><li><p>Program.cs</p><p><br  /></p></li></ul><blockquote><p><span style="font-size: 12px; color: rgb(136, 136, 136);">class Program</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">{</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; static void Main(string[] args)</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; {</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; var resouce = &quot;visual studio.iso&quot;;</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; var downloader = new Downloader();</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; downloader.DownloadProgress += new ProgressVeiw().OnProgress;</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; Console.WriteLine(&quot;正在下载 &quot; + resouce);</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; downloader.Download(resouce);</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp;</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; Console.ReadKey();</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; }</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">}</span></p></blockquote><p style=""><br  /></p><p style="">注意上面Downloader.cs注释中的<em style="border: 0px;">NOTE</em>标记，在观察者模式中，发布者应该是它自己发布消息，而此处是public修饰，可以直接在外部调用，违背了观察者模式，因此我们需要使用<strong style="border: 0px;">事件</strong>来进行访问控制。<br  /></p><p style=""><br  /></p><h2 style="">3.2 事件</h2><p><br  /></p><p style="">方法相当简单，只需要添加一个<code style="">event</code>关键字</p><p style=""><br  /></p><blockquote><p><span style="font-size: 12px; color: rgb(136, 136, 136);">//用event修饰，这样外部只能进行-=、+=操作，调用只能在本类内部进行</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">public event Actionint, int&gt; DownloadProgress;</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">//进度事件</span></p></blockquote><p><br  /></p><p><span style="">那事件和委托有什么区别？其实事件和属性一样，属语法糖，编译器会为我们生成访问器方法和实际的实例变量。</span></p><p><br style=""  /><span style="">比如上面，编译器生成了Action成员，把事件的+=,-=转换为一对public的addXxx、removeXxx方法。</span></p><p><br style=""  /><span style="">如果不想让编译器为我们自动生成委托成员，我们也可以手动实现，如：</span></p><p><span style=""><br  /></span></p><p><span style=""><br  /></span></p><p><span style=""></span></p><blockquote><p><span style="font-size: 12px; color: rgb(136, 136, 136);">public event Actionint, int&gt; DownloadProgress</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">{</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; add</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; {</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; _downloadProgress += value;</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; }</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; remove</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; {</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; &nbsp; &nbsp; _downloadProgress -= value;</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">&nbsp; &nbsp; }</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">}</span></p><p><span style="font-size: 12px; color: rgb(136, 136, 136);">private Actionint, int&gt; _downloadProgress;</span></p></blockquote><p><br  /></p><p style=""><strong style="border: 0px;"><br  /></strong></p><p style=""><strong style="border: 0px;">所以事件的作用在于，实现观察者模式只需要用event关键字定义一个实例变量即可</strong></p><p style=""><strong style="border: 0px;"><br  /></strong></p><h1 style="">其它语言相关概念</h1><p><br  /></p><h2 style="">C++</h2><p><br  /></p><p style="">C/C++中的<strong style="border: 0px;">函数指针</strong>与.Net中委托的区别在于</p><p style=""><br  /></p><ul style="" class=" list-paddingleft-2"><li><p>函数指针很“赤裸”，就是一个unsigned int类型的值，表示函数第一条CPU指令的内存地址</p><p><br  /></p></li><li><p>委托是比较复杂的CLR对象，内部封装了目标对象和方法指针，多播委托内部还维护了一个委托链</p><p><br  /></p></li></ul><p style="">C++虽然没有内置观察者模式的实现，但许多第三方库如qt、boost都提供了“信号(signal)-槽(slot)”的功能。信号相当于.Net中的事件，槽相当于事件处理方法。<br  />使用boost的signals2时需要注意的是，它实现的线程安全是指一个线程中添加、移除slot，不会影响另一个线程遍历slot集合。我们仍要注意对象被销毁的问题，比如一个slot在某线程中正在执行，而同时signal所属的那个对象在另一个线程被销毁了，这时访问那个对象会不会导致程序crash就要看运气了。</p><p style=""><br  /></p><h2 style="">Java</h2><p><br  /></p><p style="">java没有匿名方法的语法，但可以用”匿名内部类 + 单方法接口”代替，java8对语法和api进行了扩展，引入了lambda，其实只是语法糖，本质还是接口。</p><p style=""><br  />有一些第三方类库提供了观察者模式的实现，比如：谷歌guava中的EventBus。</p><p style=""><br  /></p><p><br  /></p><h2 style="">Ruby</h2><p><br  /></p><p style="">ruby语法非常丰富，这里介绍下它的block（代码块，一种匿名方法的语法：<code style="">do |param| ...end</code>&nbsp;和&nbsp;<code style="">{ |param| do_something param }</code>，这个概念来自Smalltalk）。</p><p style=""><br  />我们在写程序时会经常需要实现“回调”的功能，即接收一个函数，然后在适当的时刻调用它，ruby直接原生支持了，任何方法都可以接收一个block作为隐式的参数，不用在参数列表中显式声明，在方法里可以用yield关键字调用传进来的block。如：</p><p><br  /></p><p><span style="">再比如核心库中的File::open方法</span></p><p><span style=""><br  /></span></p><p><br  /></p><p><span style="">再看ruby的一个web框架</span>Sinatra<span style="">的API</span></p><p><span style=""><br  /></span></p><p><br  /></p><p><span style="">用这种语法来写HTTP Web应用是不是很爽？因为这种API设计可以算是实现了一种HTTP的DSL（领域专用语言）了。</span></p><p><br style=""  /><span style="">如果你喜欢这种风格，可以试试.Net的开源web框架</span>Nancy<span style="">，我已用她写了两个项目，API很实用，比ASP.NET MVC灵活。</span></p><p><br style=""  /><span style="">这里简单展示一下她的特色：content negotiation（内容协商，根据客户端请求返回指定类型内容）</span></p><p><br  /></p><p style="line-height: 25.6px; white-space: normal; max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); text-align: center; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; color: rgb(136, 136, 136); line-height: 28.4444px; box-sizing: border-box !important; word-wrap: break-word !important;">【今日微信公号推荐↓】</span></p><p style="line-height: 25.6px; white-space: normal; max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); text-align: center; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; color: rgb(136, 136, 136); line-height: 28.4444px; box-sizing: border-box !important; word-wrap: break-word !important;"><img  data-type="png" data-ratio="0.6258992805755396" data-w=""   SRC="C#委托浅析与漫谈_files/640.jpg" /></span></p><p style="line-height: 25.6px; white-space: normal; max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); text-align: center; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; line-height: 25.6px; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">更多推荐请看</span><strong style="max-width: 100%; line-height: 25.6px; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;">《</span></strong><a href="http://mp.weixin.qq.com/s?__biz=MzAxMTMxMDQ3Mw==&mid=412141169&idx=2&sn=e1aef1da0fce5c9b05cf3f639299a8dd&scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MzAxMTMxMDQ3Mw==&amp;mid=412141169&amp;idx=2&amp;sn=e1aef1da0fce5c9b05cf3f639299a8dd&amp;scene=21#wechat_redirect" style="max-width: 100%; line-height: 25.6px; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; color: rgb(255, 169, 0); box-sizing: border-box !important; word-wrap: break-word !important;">值得关注的技术和设计公众号</span></a><span style="max-width: 100%; line-height: 25.6px; font-size: 14px; box-sizing: border-box !important; word-wrap: break-word !important;"><strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 16px; box-sizing: border-box !important; word-wrap: break-word !important;">》</span></strong></span></p><p style="line-height: 25.6px; white-space: normal; max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; font-size: 14px; color: rgb(136, 136, 136); box-sizing: border-box !important; word-wrap: break-word !important;"><br style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"  /></span></p><p style="white-space: normal; max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; font-size: 14px; color: rgb(136, 136, 136); box-sizing: border-box !important; word-wrap: break-word !important;">其中推荐了包括<strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">技术</strong>、<strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">设计</strong>、<strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">极客&nbsp;</strong>和&nbsp;<strong style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;">IT相亲</strong>相关的热门公众号。技术涵盖：Python、Web前端、Java、安卓、iOS、PHP、C/C++、.NET、Linux、数据库、运维、大数据、算法、IT职场等。点击《</span><a href="http://mp.weixin.qq.com/s?__biz=MzAxMTMxMDQ3Mw==&mid=412141169&idx=2&sn=e1aef1da0fce5c9b05cf3f639299a8dd&scene=21#wechat_redirect" target="_blank" data_ue_src="http://mp.weixin.qq.com/s?__biz=MzAxMTMxMDQ3Mw==&amp;mid=412141169&amp;idx=2&amp;sn=e1aef1da0fce5c9b05cf3f639299a8dd&amp;scene=21#wechat_redirect" style="max-width: 100%; box-sizing: border-box !important; word-wrap: break-word !important;"><span style="max-width: 100%; font-size: 14px; color: rgb(255, 169, 0); box-sizing: border-box !important; word-wrap: break-word !important;">值得关注的技术和设计公众号</span></a><span style="max-width: 100%; font-size: 14px; color: rgb(136, 136, 136); box-sizing: border-box !important; word-wrap: break-word !important;">》，发现精彩！</span></p><p style="white-space: normal; max-width: 100%; min-height: 1em; color: rgb(62, 62, 62); line-height: 1.75em; box-sizing: border-box !important; word-wrap: break-word !important; background-color: rgb(255, 255, 255);"><span style="max-width: 100%; font-size: 14px; color: rgb(136, 136, 136); box-sizing: border-box !important; word-wrap: break-word !important;"><img data-s="300,640" data-type="png" data-ratio="0.9172661870503597" data-w=""  style="color: rgb(136, 136, 136); line-height: 28.4444px; text-align: center; white-space: normal; box-sizing: border-box !important; word-wrap: break-word !important; width: auto !important; visibility: visible !important; background-color: rgb(255, 255, 255);"   SRC="C#委托浅析与漫谈_files/640_2.jpg" /></span></p>
                    </div>
                    
                    <link rel="stylesheet" type="text/css" href="C#委托浅析与漫谈_files/page_mp_article_improve_combo2d1390.css">
                    
                    
                                        
                                        
                                        <div class="rich_media_tool" id="js_toobar3">
                                                                    <div id="js_read_area3" class="media_tool_meta tips_global meta_primary" style="display:none;">阅读 <span id="readNum3"></span></div>

                        <span style="display:none;" class="media_tool_meta meta_primary tips_global meta_praise" id="like3">
                            <i class="icon_praise_gray"></i><span class="praise_num" id="likeNum3"></span>
                        </span>

                        <a id="js_report_article3" style="display:none;" class="media_tool_meta tips_global meta_extra" href="">投诉</a>

                    </div>



                                    </div>

                <div class="rich_media_area_primary sougou" id="sg_tj" style="display:none">

                </div>

                <div class="rich_media_area_extra">

                    
                                        <div class="mpda_bottom_container" id="js_bottom_ad_area">
                        
                    </div>
                                        
                    <div id="js_iframetest" style="display:none;"></div>
                                        
                                        <div class="rich_media_extra" id="js_cmt_area" style="display:none">

                        <div class="discuss_container" id="js_cmt_main" style="display:none">
                            <div class="rich_tips with_line title_tips discuss_title_line">
                                <span class="tips">精选留言</span>
                            </div>
                            <p class="tips_global tc title_bottom_tips" id="js_cmt_nofans1" style="display:none;">关注该公众号可参与留言</p>
                            <p class="discuss_icon_tips title_bottom_tips tr" id="js_cmt_addbtn1" style="display:none">
                                
                                                                <a href="#comment">写留言<img class="icon_edit" src="C#委托浅析与漫谈_files/icon_edit25ded2.png" alt=""></a>
                                                            </p>
                            <ul class="discuss_list" id="js_cmt_list"></ul>
                        </div>


                        <div class="tips_global rich_split_tips tc" id="js_cmt_nofans2" style="display:none;">
                            关注该公众号可参与留言
                        </div>

                        <p class="discuss_icon_tips rich_split_tips tr" id="js_cmt_addbtn2" style="display:none">
                            
                                                        <a href="#comment">写留言<img class="icon_edit" src="C#委托浅析与漫谈_files/icon_edit25ded2.png" alt=""></a>
                                                    </p>

                        <p class="rich_split_tips tc tips_global" id="js_cmt_tips" style="display:none;"></p>


                        <div class="rich_tips tips_global loading_tips" id="js_cmt_loading">
                            <img src="C#委托浅析与漫谈_files/icon_loading_white2805ea.gif" class="rich_icon icon_loading_white" alt="">
                            <span class="tips">加载中</span>
                        </div>

                        <div class="rich_tips with_line tips_global" id="js_cmt_statement" style="display:none">
                            <span class="tips">以上留言由公众号筛选后显示</span>
                        </div>

                        <p class="rich_split_tips tc" id="js_cmt_qa" style="display:none;">
                            <a href="http://kf.qq.com/touch/sappfaq/150211YfyMVj150313qmMbyi.html?scene_id=kf264">
                                了解留言功能详情
                            </a>
                        </p>

                    </div>
                                    </div>
               
            </div>
            <div id="js_pc_qr_code" class="qr_code_pc_outer" style="display:none;">
                <div class="qr_code_pc_inner">
                    <div class="qr_code_pc">
                        <img id="js_pc_qr_code_img" class="qr_code_pc_img">
                        <p>微信扫一扫<br>关注该公众号</p>
                    </div>
                </div>
            </div>

        </div>
    </div>


        
        
        
    

    
  
  

    </body>
</html>

 
