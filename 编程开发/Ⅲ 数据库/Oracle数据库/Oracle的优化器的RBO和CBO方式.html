<!DOCTYPE html>
<html><head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">

<!--defaultCSS-->
<title>Oracle的优化器的RBO和CBO方式</title>




<style type="text/css" id="wiz_todo_style_id" wiz_link_version="01.00.07">.wiz-todo, .wiz-todo-img {width: 16px; height: 16px; cursor: default; padding: 0 10px 0 2px; vertical-align: -10%;-webkit-user-select: none;} .wiz-todo-label {margin-top: 8px; margin-bottom: 8px; line-height: 1;} .wiz-todo-label-checked { /*text-decoration: line-through;*/ color: #666;} .wiz-todo-label-unchecked {text-decoration: initial;} .wiz-todo-completed-info {padding-left: 44px; display: inline-block; } .wiz-todo-avatar { width:20px; height: 20px; vertical-align: -20%; margin-right:10px; border-radius: 2px;} .wiz-todo-account, .wiz-todo-dt { color: #666; }</style>
<style type="text/css" id="wiz_custom_css">
body
{
    font-family: "Microsoft YaHei UI","Microsoft YaHei",SimSun,"Segoe UI",Tahoma,Helvetica,Sans-Serif,"Microsoft YaHei", Georgia,Helvetica,Arial,sans-serif,宋体, PMingLiU,serif;
    font-size: 10.5pt;
    line-height: 1.5;
}
html, body
{
    
    
}
h1 {
    font-size:1.5em;
    font-weight:bold;
}
h2 {
    font-size:1.4em;
    font-weight:bold;
}
h3 {
    font-size:1.3em;
    font-weight:bold;
}
h4 {
    font-size:1.2em;
    font-weight:bold;
}
h5 {
    font-size:1.1em;
    font-weight:bold;
}
h6 {
    font-size:1.0em;
    font-weight:bold;
}
img {
    border:0;
    max-width: 100%;
}
blockquote {
    margin-top:0px;
    margin-bottom:0px;
}

</style>
</head>

<body style="" ><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px;"><span class="204001603-13082008" style="line-height: 15px;"><span style="background-color: rgb(192, 255, 255);">

</span><div><!--WizRtf2Html Charset=0  --><span style="font-size: 10pt; color: rgb(0, 128, 128); font-family: 'Courier New', monospace; background-color: rgb(192, 255, 255);">SELECT<span style="color: rgb(0, 0, 128);">&nbsp;<span style="font-style:italic;color:#ff0000;">/*+rule*/</span></span></span></div>
<div><span style="font-size: 10pt; color: rgb(0, 0, 128); font-family: 'Courier New', monospace; background-color: rgb(192, 255, 255);">&nbsp;A.PANELBARCODE,</span></div>
<div><span style="font-size: 10pt; color: rgb(0, 0, 128); font-family: 'Courier New', monospace; background-color: rgb(192, 255, 255);">&nbsp;A.PARTNUM,</span></div>
<div><span style="font-size: 10pt; color: rgb(0, 0, 128); font-family: 'Courier New', monospace; background-color: rgb(192, 255, 255);">&nbsp;A.REFDESIGNATOR,</span></div>
<div><span style="font-size: 10pt; color: rgb(0, 0, 128); font-family: 'Courier New', monospace; background-color: rgb(192, 255, 255);">&nbsp;A.USERDATA,</span></div>
<div><span style="font-size: 10pt; color: rgb(0, 0, 128); font-family: 'Courier New', monospace; background-color: rgb(192, 255, 255);">&nbsp;TO_CHAR(A.RELEASETIME_DT,&nbsp;<span style="color:#0000ff;">'yyyy-MM-dd'</span>)</span></div>
<div><span style="font-size: 10pt; color: rgb(0, 0, 128); font-family: 'Courier New', monospace; background-color: rgb(192, 255, 255);">&nbsp;&nbsp;<span style="color:#008080;">FROM</span>&nbsp;PANA.PFSA_PANA_TRACE_PLACE&nbsp;A</span></div>
<div><span style="font-size: 10pt; color: rgb(0, 0, 128); font-family: 'Courier New', monospace; background-color: rgb(192, 255, 255);">&nbsp;<span style="color:#008080;">WHERE</span>&nbsp;A.REFDESIGNATOR&nbsp;=&nbsp;<span style="color:#0000ff;">'UL1'</span></span></div>
<span style="background-color: rgb(192, 255, 255);"><span style="font-size: 10pt; color: rgb(0, 0, 128); font-family: 'Courier New', monospace;">&nbsp;&nbsp;&nbsp;<span style="color:#008080;">AND</span>&nbsp;A.PARTNUM&nbsp;=&nbsp;<span style="color:#0000ff;">'SA000060V00'</span></span>&nbsp;&nbsp;</span><font face="幼圆" size="4" style="background-color: rgb(255, 255, 255);"><strong><br></strong></font></span></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><span class="204001603-13082008" style="line-height: 15px;"><font face="幼圆" size="4"><strong><br></strong></font></span></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><span class="204001603-13082008" style="line-height: 15px;"><font face="幼圆" size="4"><strong><br></strong></font></span></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><span class="204001603-13082008" style="line-height: 15px;"><font face="幼圆" size="4"><strong>Oracle的优化器的RBO和CBO方式</strong></font></span></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><span class="204001603-13082008" style="line-height: 15px;"><font size="2"></font></span>&nbsp;</div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><span class="204001603-13082008" style="line-height: 15px;"></span>&nbsp;</div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><strong><font size="2"><span class="204001603-13082008" style="line-height: 15px; font-size: 13px;">1、</span>基于规则的优化方式(Rule-Based Optimization，简称为RBO)</font></strong></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><strong><font size="2"></font></strong>&nbsp;</div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><font size="2"><span class="204001603-13082008" style="line-height: 15px; font-size: 13px;">&nbsp;&nbsp;&nbsp;&nbsp;</span>优化器在分析SQL语句时,所遵循的是Oracle内部预定的一些规则，对数据是不敏感的。它只借助少量的信息来决定一个sql语句的执行计划，包括：<br><span class="204001603-13082008" style="line-height: 15px; font-size: 13px;">&nbsp;&nbsp;&nbsp;&nbsp;</span>1）sql语句本身<br><span class="204001603-13082008" style="line-height: 15px; font-size: 13px;">&nbsp;&nbsp;&nbsp;&nbsp;</span>2）sql中涉及到的table、view、index等的基本信息<br><span class="204001603-13082008" style="line-height: 15px; font-size: 13px;">&nbsp;&nbsp;&nbsp;&nbsp;</span>3）本地数据库中数据字典中的信息（远程数据库数据字典信息对RBO是无效的）</font></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><font size="2"><span class="204001603-13082008" style="line-height: 15px; font-size: 13px;">&nbsp;&nbsp;&nbsp; 例如：</span>我们常见的，当一个where子句中的一列有索引时去走索引。但是需要注意，走索引不一定就是优的，比如一个表只有两行数据，一次IO就可以完成全表的检索,而此时走索引时则需要两次IO,这时全表扫描(full table scan)的效率更优。</font></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><font size="2"></font>&nbsp;</div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><font size="2"></font>&nbsp;</div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><strong><font size="2"><span class="204001603-13082008" style="line-height: 15px; font-size: 13px;">2、</span>基于代价的优化方式(Cost-Based Optimization，简称为CBO)</font></strong></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><strong><font size="2"></font></strong>&nbsp;</div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><font size="2"><span class="204001603-13082008" style="line-height: 15px; font-size: 13px;">&nbsp;&nbsp;&nbsp;&nbsp;</span>它是看语句的代价(Cost),通过代价引擎来估计每个执行计划所需的代价，该代价将每个执行计划所耗费的资源进行量化，CBO根据这个代价选择出最优的执行计划。一个查询所耗费的资源可分为三部分：I/O代价、CPU代价、NETWORK代价。I/O是指把数据从磁盘读入内存时所需代价（该代价是查询所需最主要的，所以在优化时一个基本原则就是降低I/O总次数）；CPU代价是指处理内存中数据所需的代价，数据一旦读入内存，当我们识别出我们所要的数据后，会在这些数据上执行排序（sort）或连接（join）操作，这需要消耗CPU资源；对于访问远程节点来说，network代价的花费也是很大的。</font></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><font size="+0"><font size="2"><span class="204001603-13082008" style="line-height: 15px; font-size: 13px;">&nbsp;&nbsp;&nbsp;&nbsp;</span>优化器在判断是否用这种方式时,主要参照的是表及索引的统计信息。统计信息给出表的大小、有多少行、每行的长度等信息。这些统计信息起初在库内是没有的，是做analyze后才出现的，很多的时侯过期统计信息会令优化器做出一个错误的执行计划,因些应及时更新这些信息（dbms_stat.analyze）。</font></font></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><span class="204001603-13082008" style="line-height: 15px;"><font size="2">&nbsp;&nbsp;&nbsp; 如星型连接排列查询，哈希连接查询，函数索引，和并行查询等一些技术都是基于CBD的。</font></span></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><font size="2"></font>&nbsp;</div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><font size="2"></font>&nbsp;</div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px;"><strong><font size="2"><span class="204001603-13082008" style="background-color: rgb(255, 255, 255); line-height: 15px; font-size: 13px;">3、</span><span style="background-color: rgb(192, 255, 255);">优化模式包括Rule、Choose、First rows、All rows四种方式：</span></font></strong></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><font size="2"></font>&nbsp;</div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><font size="2"><span class="204001603-13082008" style="line-height: 15px; font-size: 13px;">&nbsp;&nbsp;&nbsp;&nbsp;</span><strong>Rule：</strong>基于规则的方式。</font></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><font size="2"><span class="204001603-13082008" style="line-height: 15px; font-size: 13px;">&nbsp;&nbsp;&nbsp;&nbsp;</span><strong>Choolse：</strong>默认的情况下Oracle用的便是这种方式。指的是当一个表或或索引有统计信息，则走CBO的方式，如果表或索引没统计信息，表又不是特别的小，而且相应的列有索引时，那么就走索引，走RBO的方式。</font></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><font size="2"><span class="204001603-13082008" style="line-height: 15px; font-size: 13px;">&nbsp;&nbsp;&nbsp;&nbsp;</span><strong>First Rows：</strong>它与Choose方式是类似的，所不同的是当一个表有统计信息时，它将是以最快的方式返回查询的最先的几行，从总体上减少了响应时间。</font></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><font size="2"><span class="204001603-13082008" style="line-height: 15px; font-size: 13px;">&nbsp;&nbsp;&nbsp;&nbsp;</span><strong>All Rows:</strong>也就是我们所说的Cost的方式，当一个表有统计信息时，它将以最快的方式返回表的所有的行，从总体上提高查询的吞吐量。没有统计信息则走RBO的方式。</font></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><font size="2"></font>&nbsp;</div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><font size="2"></font>&nbsp;</div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><strong><font size="2"><span class="204001603-13082008" style="line-height: 15px; font-size: 13px;">4、</span>设定选用哪种优化模式：</font></strong></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><font size="2"><span class="204001603-13082008" style="line-height: 15px; font-size: 13px;">&nbsp;&nbsp;&nbsp;&nbsp;</span>A、在initSID.ora中设定OPTIMIZER_MODE=RULE/CHOOSE/FIRST_ROWS/ALL_ROWS（默认是Choose）<br>&nbsp;&nbsp;&nbsp; B、Sessions级别通过：ALTER SESSION SET OPTIMIZER_MODE=RULE/CHOOSE/FIRST_ROWS/ALL_ROWS<br>&nbsp;&nbsp;&nbsp; C、语句级别用Hint（/*+ ... */）来设定</font></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><font size="2"><span class="204001603-13082008" style="line-height: 15px; font-size: 13px;"></span></font>&nbsp;</div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><font size="2"><span class="204001603-13082008" style="line-height: 15px; font-size: 13px;"></span></font>&nbsp;</div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><font size="2"><span class="204001603-13082008" style="line-height: 15px; font-size: 13px;"><strong>5、一些常见的问题：</strong></span></font></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><font size="2"><span class="204001603-13082008" style="line-height: 15px; font-size: 13px;"></span></font>&nbsp;</div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><span class="204001603-13082008" style="line-height: 15px;"></span><font size="2"><span class="204001603-13082008" style="line-height: 15px; font-size: 13px;">&nbsp;&nbsp;</span>A、为什么表的某个字段明明有索引，但执行计划却不走索引？</font></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><font size="2"><span class="204001603-13082008" style="line-height: 15px; font-size: 13px;">&nbsp;&nbsp;&nbsp;&nbsp;</span>1、优化模式是all_rows的方式&nbsp;<br>&nbsp;&nbsp;&nbsp; 2、表作过analyze，有统计信息<br>&nbsp;&nbsp;&nbsp; 3、表很小，上文提到过的，Oracle的优化器认为不值得走索引。</font></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><font size="2"></font>&nbsp;</div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><span class="204001603-13082008" style="line-height: 15px;"><font size="2">&nbsp; B、使用CBO时，SQL语句中为什么不能引用系统数据字典表或视图？</font></span></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><span class="204001603-13082008" style="line-height: 15px;"><font size="2">&nbsp;&nbsp;&nbsp; 1、因为系统数据字典表都未被分析过，可能导致极差的“执行计划”。</font></span></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><span class="204001603-13082008" style="line-height: 15px;"><font size="2">&nbsp;&nbsp;&nbsp; 2、擅自对数据字典表做分析，可能导致死锁，或系统性能严重下降。</font></span></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><span class="204001603-13082008" style="line-height: 15px;"><font size="2"></font></span>&nbsp;</div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><span class="204001603-13082008" style="line-height: 15px;"><font size="2">&nbsp; C、使用CBO时如何选择表连接方式？</font></span></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><span class="204001603-13082008" style="line-height: 15px;"><font size="2">&nbsp;&nbsp;&nbsp; 1、CBO有时会偏重于SMJ和HJ，但在OLTP系统中，NL一般会更好，因为它高效的使用了索引。</font></span></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><span class="204001603-13082008" style="line-height: 15px;"><font size="2">&nbsp;&nbsp;&nbsp; 2、SMJ即使相关列上建有索引，最多只能因索引的存在，避免数据排序过程。</font></span></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><span class="204001603-13082008" style="line-height: 15px;"><font size="2">&nbsp;&nbsp;&nbsp; 3、HJ由于须做HASH运算，索引的存在对数据查询速度几乎没有影响。</font></span></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><span class="204001603-13082008" style="line-height: 15px;"><font size="2"></font></span>&nbsp;</div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><span class="204001603-13082008" style="line-height: 15px;"><font size="2">&nbsp; D、使用CBO时，需要注意什么吗？</font></span></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><span class="204001603-13082008" style="line-height: 15px;"><font size="2">&nbsp;&nbsp;&nbsp; 1、必须保证为表和相关的索引搜集足够的统计数据，</font>&nbsp;</span><span class="204001603-13082008" style="line-height: 15px;"><font size="2">对数据经常有增、删、改的表最好定期对表和索引进行分析</font></span></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><span class="204001603-13082008" style="line-height: 15px;"><font size="2">&nbsp;&nbsp;&nbsp; 2、可用SQL语句：analyze table xxx compute statistics for all indexes</font></span></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><span class="204001603-13082008" style="line-height: 15px;"><font size="2"></font></span>&nbsp;</div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><font size="2"><span class="204001603-13082008" style="line-height: 15px; font-size: 13px;">&nbsp; E、为什么有时使用CBO会比较慢？</span></font></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><font size="2"><span class="204001603-13082008" style="line-height: 15px; font-size: 13px;">&nbsp;&nbsp;&nbsp; 1、没有对表或视图进行Analyze</span></font></div><div style="font-family: Verdana, Geneva, Arial, Helvetica, sans-serif; font-size: 13px; line-height: 16px; background-color: rgb(255, 255, 255);"><font size="2"><span class="204001603-13082008" style="line-height: 15px; font-size: 13px;">&nbsp;&nbsp;&nbsp; 2、SQL进行CBO时对于没有Analyze的对象会自动进行Analyze，因此造成运行缓慢</span></font></div><br><div style="color:gray"><small>来源：&nbsp;&lt;<a href="http://www.blogjava.net/wxqxs/archive/2008/08/13/221716.html">http://www.blogjava.net/wxqxs/archive/2008/08/13/221716.html</a><small>&gt;</small></small></div><small><small>&nbsp;</small></small>



</body></html>